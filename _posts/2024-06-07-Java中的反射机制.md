---
layout: mypost
title: "Javaä¸­çš„åå°„æœºåˆ¶"
categories: [Javaå®‰å…¨]
---

> åå°„æ˜¯â¼¤å¤šæ•°è¯­â¾”â¾¥éƒ½å¿…ä¸å¯å°‘çš„ç»„æˆéƒ¨åˆ†ï¼Œå¯¹è±¡å¯ä»¥é€šè¿‡åå°„è·å–ä»–çš„ç±»ï¼Œç±»å¯ä»¥é€šè¿‡åå°„æ‹¿åˆ°æ‰€æœ‰
> â½…æ³•ï¼ˆåŒ…æ‹¬ç§æœ‰ï¼‰ï¼Œæ‹¿åˆ°çš„â½…æ³•å¯ä»¥è°ƒâ½¤ï¼Œæ€»ä¹‹é€šè¿‡åå°„ï¼Œæˆ‘ä»¬å¯ä»¥å°† Java è¿™ç§é™æ€è¯­â¾”é™„åŠ ä¸ŠåŠ¨æ€
> ç‰¹æ€§ã€‚ -- P ç¥

## å‰è¨€

è¿‘æœŸæ¸©ä¹ ï¼Œè®°å½• ğŸ“ ä¸€äº›è‡ªå·±å¯¹äº Java è¿™é—¨è¯­è¨€ä¸­åå°„çš„æ€è€ƒï¼Œæ–‡ç« ç»“æ„ä» 0 åˆ° 1......

## class å’Œ Class å’Œ .class çš„åŒºåˆ«

- classï¼šclass æ˜¯ Java ä¸­çš„ä¸€ä¸ªå…³é”®å­—ï¼Œç±»å˜›å°±æ˜¯ä¸€ç§æ¨¡æ¿ï¼Œä¸€ç§æ•°æ®ç»“æ„ã€‚

```java
public class exp {
    public static void main(String[] args) {
        System.out.println("Hello World");
    }
}
```

- Classï¼šClass æ˜¯ Java ä¸­çš„ä¸€ä¸ªç±»ï¼Œåœ¨ java.lang åŒ…ä¸­ï¼ŒClass ç±»çš„å®ä¾‹æ˜¯ Personã€String...... ç­‰ç±»çš„æè¿°ç¬¦ï¼Œè€Œ Class ç±»æœ¬èº«æ˜¯å®šä¹‰è¿™äº›æè¿°ç¬¦çš„ç±»ã€‚

- .classï¼šç”¨ javac ç¼–è¯‘ Java æºä»£ç æ–‡ä»¶æ—¶ï¼Œç¼–è¯‘å™¨ä¼šå°† Java æºä»£ç è½¬æ¢ä¸º JVM å¯æ‰§è¡Œçš„å­—èŠ‚ç æ–‡ä»¶ï¼Œæœ€ç»ˆç”Ÿæˆä¸€ä¸ª .class æ–‡ä»¶ã€‚

.class æ–‡ä»¶åŒ…å«çš„æ˜¯æœºå™¨å¯è¯»çš„å­—èŠ‚ç ï¼Œè¿™äº›å­—èŠ‚ç ç”± JVM æ‰§è¡Œï¼ŒClass å¯¹è±¡åˆ™æ˜¯å¯¹è¯¥å­—èŠ‚ç çš„æŠ½è±¡æè¿°ï¼Œå¯ä»¥é€šè¿‡åå°„æœºåˆ¶åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°æ“ä½œç±»çš„ç»“æ„ã€‚

## ç±»ç¼–è¯‘å’Œç±»åŠ è½½å’Œç±»åˆå§‹åŒ–çš„åŒºåˆ«

èƒŒæ™¯ï¼šæœ‰ä¸€ä¸ª Test.java æ–‡ä»¶

- ç±»ç¼–è¯‘ï¼šç”¨ javac ç¼–è¯‘ Test.java æ—¶ï¼Œç¼–è¯‘å™¨ä¼šæŠŠ Test.java è½¬æ¢ä¸ºå­—èŠ‚ç æ–‡ä»¶ Test.classã€‚æ­¤æ—¶ï¼ŒTest.class æ–‡ä»¶å·²ç»å­˜åœ¨äºæ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œä½†æ˜¯è¿™ä¸ª .class æ–‡ä»¶å¹¶æ²¡æœ‰è¢«åŠ è½½åˆ° JVM å†…å­˜ä¸­ã€‚

- ç±»åŠ è½½ï¼šç±»åŠ è½½å‘ç”Ÿåœ¨ JVM è¿è¡Œæ—¶ã€‚åªæœ‰å½“ç±»éœ€è¦è¢«æ‰§è¡Œæˆ–è®¿é—®æ—¶ï¼ŒJVM æ‰ä¼šåŠ è½½è¯¥ç±»ã€‚åŠ è½½è¿‡ç¨‹ç”±ç±»åŠ è½½å™¨ï¼ˆClassLoaderï¼‰ç®¡ç†ï¼Œé€šå¸¸æ˜¯æŒ‰éœ€åŠ è½½ï¼ˆæ‡’åŠ è½½ï¼‰ï¼Œå³åªåœ¨ç±»è¢«ä½¿ç”¨æ—¶åŠ è½½ã€‚

- ç±»åˆå§‹åŒ–ï¼šæ˜¯æŒ‡æ‰§è¡Œç±»çš„é™æ€åˆå§‹åŒ–å—ï¼ˆstatic {}ï¼‰å’Œé™æ€å˜é‡çš„èµ‹å€¼ã€‚å®ƒä¼šå‘ç”Ÿåœ¨ç±»çš„ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶ã€‚

ç±»å¯ä»¥è¢«åŠ è½½ä½†ç±»ä¸ä¸€å®šè¢«åˆå§‹åŒ–ï¼Œç®€å•ä¾‹å­å¦‚ä¸‹-->

```java
public class exp {

    static{
        System.out.println("Loaded exp static block");
    }

    public static void main(String[] args) {
        try {
            Class.forName("com.reflection02.exp", false, exp.class.getClassLoader());
            Class.forName("com.reflection02.misc", false, misc.class.getClassLoader());
        }catch (ClassNotFoundException e){
            e.printStackTrace();
        }
    }
}

class misc{

    static{
        System.out.println("Loaded misc static block");
    }
}
```

è¾“å‡ºç»“æœï¼š

```
Loaded exp static block
```

å…¶ä¸­ç€é‡çœ‹ misc ç±»ï¼Œå®ƒè¢«åŠ è½½äº†ï¼Œä½†æ˜¯æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰å»æ‰§è¡Œé™æ€å—ï¼Œæ— è¾“å‡ºã€‚`Loaded exp static block`æ˜¯åœ¨`Class.forName("com.reflection02.exp", false, exp.class.getClassLoader());`è¿™æ¡è¯­å¥æ‰§è¡Œå‰å°±å·²ç»è¾“å‡ºäº†ï¼ŒåŸå› æ˜¯ exp ç±»æ˜¯ public ç±»ï¼Œå¹¶ä¸”åŒ…å« main æ–¹æ³•ï¼ŒJVM ä¼šåœ¨å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½å¹¶åˆå§‹åŒ– exp ç±»ï¼Œå› æ­¤é™æ€åˆå§‹åŒ–å—è¢«æ‰§è¡Œã€‚

## forName å‡½æ•°

å®ƒæœ‰ä¸¤ä¸ªå‡½æ•°é‡è½½ï¼Œç¬¬ä¸€ä¸ªæ˜¯`forName(String className)`ï¼Œç¬¬äºŒä¸ªæ˜¯`forName(String className, boolean initialize, ClassLoader loader)`ï¼Œå…¶ä¸­`initialize`å‚æ•°è¡¨ç¤ºæ˜¯å¦è¦åˆå§‹åŒ–è¯¥ç±»ï¼Œ`loader`å‚æ•°è¡¨ç¤ºè¦åŠ è½½çš„ç±»æ‰€åœ¨çš„ç±»åŠ è½½å™¨ã€‚

å…¶ä¸­`initialize`å‚æ•°æ˜¯`false`ï¼Œé‚£ä¹ˆå°±ä¸ä¼šå»åˆå§‹åŒ–è¯¥ç±»ï¼Œ`initialize`å‚æ•°æ˜¯`true`ï¼Œé‚£ä¹ˆå°±ä¼šå»åˆå§‹åŒ–è¯¥ç±»ã€‚æœ‰å…³äºç±»çš„åˆå§‹åŒ–ç›¸å…³çš„å†…å®¹ï¼Œå¯ä»¥å¤ä¹ ä¸€ä¸‹[æµ…è°ˆ Java å†…å­˜åˆ†é…æœºåˆ¶](https://clicking777.top/posts/2024/06/01/%E6%B5%85%E8%B0%88Java%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E6%9C%BA%E5%88%B6.html)ï¼Œå¼„æ¸…æ¥šç±»åˆå§‹åŒ–è¿‡ç¨‹ä¸­å„ä¸ªéƒ¨åˆ†æ‰§è¡Œçš„å…ˆåé¡ºåºã€‚

## ä¸ºä»€ä¹ˆè¦è·å– Class å¯¹è±¡

å®ƒæ˜¯åå°„çš„å¿…ç„¶äº§ç‰©ä¸”åå°„éœ€è¦å®ƒï¼Œé‚£ä¹ˆä½•ä¸ºåå°„ï¼Ÿæœ€ç²¾è¾Ÿçš„è¯æ€»ç»“ä¸€ä¸‹ï¼šåå°„å¯ä»¥è®©ä¸€ä¸ªç±»è¢«ä½¿ç”¨ï¼Œä½†æ˜¯åœ¨ç¨‹åºå¼€å§‹è¿è¡Œæ—¶å€™ä¸è¢« JVM åŠ è½½ï¼Œè‡ªç”±æ§åˆ¶ç±»è¢«åŠ è½½çš„æ—¶æœºå’Œæ–¹å¼ã€‚ä¸€æ—¦ç±»è¢«åŠ è½½äº†ï¼Œé‚£å°±ä¼šç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„æœ‰å…³è¿™ä¸ªç±»çš„æè¿°å‹ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯ Class å¯¹è±¡ï¼Œä¹‹åçš„ç§ç§æ“ä½œä¹Ÿéƒ½ç¦»ä¸å¼€è¿™ä¸ª Class å¯¹è±¡ã€‚

## è·å– Class å¯¹è±¡çš„æ–¹å¼

1.`misc.class`ï¼Œå¦‚æœå·²ç»åŠ è½½äº†æŸä¸ªç±»ï¼Œåªæ˜¯æƒ³è·å–åˆ°å®ƒçš„ java.lang.Class å¯¹è±¡ï¼Œé‚£ä¹ˆå°±ç›´æ¥
æ‹¿å®ƒçš„ class å±æ€§å³å¯ï¼Œä½†å‰æä¸€å®šæ˜¯è¿™ä¸ªç±»å·²ç»åŠ è½½äº†ã€‚ä¸‹é¢ä»£ç è¯´æ˜ä¸€ä¸‹-->

```java
public class exp {

    public static void main(String[] args) {
        Class<?> clazz = misc.class;
    }
}

class misc{

    static {
        System.out.println("Loaded misc static block");
    }
}
```

è¾“å‡ºç»“æœï¼š

```
Loaded exp static block
```

æ˜¾è€Œæ˜“è§çš„ç»“æœï¼Œmisc ç±»è¢«åŠ è½½äº†ä½†æ˜¯æ²¡æœ‰å»åˆå§‹åŒ–ï¼Œæ‰€ä»¥æ²¡æœ‰è¾“å‡º`Loaded misc static block`ã€‚è¿™ç§å…¶å®ä¸æ˜¯åå°„ï¼Œå› ä¸ºåœ¨å†™å‡ºè¿™æ ·çš„ exp.java çš„æ—¶å€™ï¼Œmisc ç±»å°±å·²ç»è¦è¢« JVM åŠ è½½äº†ã€‚

2.`Class.forName("com.reflection02.misc")`ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯é€šè¿‡ç±»çš„å…¨é™å®šåæ¥è·å–ç±»çš„ Class å¯¹è±¡ï¼Œå®ƒä¼šåŠ è½½å¹¶åˆå§‹åŒ–è¯¥ç±»ã€‚ä¸Šæ–‡è§è¿‡ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚

3.`object.getClass()`ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯é€šè¿‡å¯¹è±¡æ¥è·å–ç±»çš„ Class å¯¹è±¡ï¼Œå®ƒä¼šåŠ è½½å¹¶åˆå§‹åŒ–è¯¥ç±»ã€‚è¿™ç§ä¹Ÿå±äºåå°„ï¼Œæ¯•ç«Ÿæ˜¯åœ¨å¯¹å¯¹è±¡è¿›è¡Œæ“ä½œï¼Œè‚¯å®šæ˜¯åœ¨è¿è¡Œæ—¶å€™å»åŠ è½½ç±»çš„ï¼Œè€Œéä¸€å¼€å§‹ç±»å°±è¢« JVM åŠ è½½ã€‚ä¸¾ä¸ªä¾‹å­-->

```java
public class exp {

    public static void main(String[] args) {
        misc misc = new misc();
        Class<?> clazz = misc.getClass();
    }
}

class misc{

    static {
        System.out.println("Loaded misc static block");
    }
}
```

è¾“å‡ºç»“æœï¼š

```
Loaded misc static block
```

## åå°„ä¸­åŸºç¡€çš„ 4 ä¸ªæ–¹æ³•

- è·å– Class å¯¹è±¡çš„â½…æ³•ï¼šforName
- å®ä¾‹åŒ–ç±»çš„â½…æ³•ï¼šnewInstance
- è·å–å‡½æ•°çš„â½…æ³•ï¼šgetMethod
- æ‰§â¾å‡½æ•°çš„â½…æ³•ï¼šinvoke

  1.forName åœ¨ä¸Šæ–‡å·²ç»è¯¦ç»†è®°å½•ï¼ŒæŒ‰é¡ºåºçœ‹çœ‹ newInstanceï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯é€šè¿‡ Class å¯¹è±¡åˆ›å»ºç±»çš„å®ä¾‹ï¼Œ`newInstance()`è°ƒç”¨ç±»çš„æ— å‚æ„é€ å‡½æ•° æ¥åˆ›å»ºç±»çš„å®ä¾‹ã€‚å†™ä¸€ä¸ªä¾‹å­è¯´æ˜ï¼ˆæ˜¾ç¤ºçš„å†™å‡ºæ¥äº†ï¼Œä¸å†™è¿™ä¸ª Misc ç±»çš„æ„é€ å‡½æ•°ä¹Ÿæ˜¯ä¼šè¢« newInstance éšå¼è°ƒç”¨çš„ï¼‰-->

```java
public class EXP {

    public static void main(String[] args) {
        try {
            Class<?> clazz = Class.forName("com.reflection04.Misc");
            Object obj = clazz.newInstance();
        }catch (Exception e){
            e.printStackTrace();
        }
    }
}

class Misc{

    static {
        System.out.println("Loaded Misc static block");
    }

    Misc(){
        System.out.println("Loaded Misc block");
    }
}
```

è¾“å‡ºç»“æœï¼š

```
Loaded Misc static block
Loaded Misc block
```

å¦‚æœè¿™ä¸ªæ—¶å€™æŠŠ Misc çš„æ„é€ å‡½æ•°é‡å†™ä¸ºæœ‰å‚æ„é€ æˆ–è€…æ”¹ä¸º privateï¼Œé‚£ä¹ˆå°±ä¼šæŠ¥é”™-->

```java
public class EXP {

    public static void main(String[] args) {
        try {
            Class<?> clazz = Class.forName("com.reflection04.Misc");
            Object obj = clazz.newInstance();
        }catch (Exception e){
            e.printStackTrace();
        }
    }
}

class Misc{

    static {
        System.out.println("Loaded Misc static block");
    }

    Misc(String msg) {
        System.out.println("Loaded Misc block with message: " + msg);
    }
}
```

è¾“å‡ºç»“æœï¼š

![](1.png)

è¿™å°±æ˜¯å†™ EXP æ—¶å€™ï¼Œä½¿ç”¨ newInstance æ–¹æ³•å»å®ä¾‹åŒ–æŸäº›ç±»ä¼šæŠ¥é”™çš„åŸå› ï¼Œè¦ä¹ˆæ˜¯ä½¿ç”¨çš„ç±»æ²¡æœ‰æ— å‚æ„é€ å‡½æ•°ï¼Œè¦ä¹ˆæ˜¯è¯¥ç±»æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„ï¼Œ`java.lang.Runtime`è¿™ä¸ªç±»å°±æ˜¯è¿™æ ·çš„ï¼Œå®ƒçš„æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„ï¼Œæ‰€ä»¥ä¸èƒ½é€šè¿‡ newInstance å»å®ä¾‹åŒ–å®ƒã€‚

2.æŠŠ getMethod å’Œ invoke æ”¾åœ¨ä¸€èµ·è®°å½•ï¼ŒgetMethod çš„ä½œç”¨æ˜¯é€šè¿‡åå°„è·å–ä¸€ä¸ªç±»çš„æŸä¸ªç‰¹å®šçš„å…¬æœ‰æ–¹æ³•ï¼Œæ³¨æ„ç‚¹æ˜¯è¦ä¼ å‡½æ•°åä¸å‚æ•°ç±»å‹ï¼ˆå’Œæ–¹æ³•çš„é‡è½½æœ‰å…³ï¼Œå…‰é ä¸€ä¸ªå‡½æ•°åæ˜¯ç¡®å®šä¸äº†å‡½æ•°çš„åŠŸèƒ½çš„ï¼‰ã€‚invoke çš„ä½œç”¨æ˜¯æ‰§è¡Œæ–¹æ³•ï¼Œæ³¨æ„ç‚¹å¼ invoke ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°-->å¦‚æœè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªæ™®é€šæ–¹æ³•ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç±»å¯¹è±¡ï¼Œå¦‚æœè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç±»ã€‚ç†è§£å¦‚ä¸‹-->

```
æ­£å¸¸æ‰§è¡Œæ–¹æ³•ï¼š [1].method([2], [3], [4]...)
åå°„æ‰§è¡Œæ–¹æ³•ï¼šmethod.invoke([1], [2], [3], [4]...)
```

3.å®æ“ï¼šæ„é€  EXP æ‹¿`java.lang.Runtime.exec()`æ¥æ‰§è¡Œå‘½ä»¤

ä¸‹é¢è¿™ç§å†™æ³•è‚¯å®šæ˜¯ä¸å¯ä»¥ âŒ çš„

```java
public class EXP {

    public static void main(String[] args) {
        try{
            Class<?> clazz = Class.forName("java.lang.Runtime");
            clazz.getMethod("exec",String.class).invoke(clazz.newInstance(),"whoami");
        }catch (Exception e){
            e.printStackTrace();
        }
    }
}
```

è¾“å‡ºç»“æœï¼š

![](2.png)

åŸå› æ˜¯`java.lang.Runtime`è¿™ä¸ªç±»çš„æ„é€ æ–¹æ³•æ˜¯ç§æœ‰çš„ï¼Œæ‰€ä»¥ä¸èƒ½é€šè¿‡ newInstance å»å®ä¾‹åŒ–å®ƒï¼Œä¸‹é¢è´´å›¾ Runtime ç±»å®ç°å•ä¾‹æ¨¡å¼çš„å…³é”®çš„ä¸‰å—ä»£ç 

![](3.png)

![](4.png)

åˆ™ä¿®æ”¹ä¸ºå¦‚ä¸‹ä»£ç -->

```java
public class EXP {

    public static void main(String[] args) {
        try{
            Class<?> clazz = Class.forName("java.lang.Runtime");
            clazz.getMethod("exec",String.class).invoke(clazz.getMethod("getRuntime").invoke(clazz),"ping 9mkbi.cxsys.spacestabs.top");
        }catch (Exception e){
            e.printStackTrace();
        }
    }
}
```

è¿è¡Œåè§¦å‘å‘½ä»¤æ‰§è¡Œ

![](5.png)

## åå°„ä¸­çš„å¤šæ€

è¿™ä¸ªæœ¬æ¥æ‰“ç®—æ”¾ä¸Šé¢çš„ newInstance å‡½æ•°è¿™é‡Œï¼Œéƒ½æ”¾ä¸Šé¢å¯èƒ½æœ‰ç‚¹è‡ƒè‚¿ï¼Œè¿˜æ˜¯å•ç‹¬æ‹‰å‡ºæ¥äº†ï¼Œç»™ä¸‰è¡Œä½“ç°å¤šæ€å…³é”®ä»£ç ï¼ˆè¿˜æ˜¯ä»ä¸Šé¢ç»™çš„å®ä¾‹ä¸­æ‘˜å‡ºæ¥çš„ï¼‰

```
Class<?> clazz = Class.forName("com.reflection04.Misc");
Object obj = clazz.newInstance();
Misc misc = (Misc) obj;
```

è¿™ä¸ªå’Œä¹‹å‰å­¦ä¹  Java ç‰¹æ€§ä¸­çš„å¤šæ€æ˜¯ä¸€æ ·çš„ï¼Œå›é¡¾ä¸€ä¸‹å¤šæ€ï¼Œç®€å•å†™ä¸ªä»£ç ç¤ºä¾‹-->

```java
public class Father {

    public static void main(String[] args) {
        Father father = new Son();
        father.eat();
        Son son = (Son)father;
        son.eat();
    }

    public void eat() {
        System.out.println("Father Eating");
    }
}
class Son extends Father{

    public void eat() {
        System.out.println("Son Eating");
    }

    public void sleep() {
        System.out.println("Son Sleeping");
    }
}
```

ä¸éš¾å‘ç°éƒ½æ˜¯å…ˆå»å®ä¾‹åŒ–äº†å­ç±»ï¼ˆåå°„é‚£ä¸ªä¾‹å­ï¼Œæ‰€æœ‰ç±»éƒ½é»˜è®¤ç»§æ‰¿äº† Object ç±»ï¼Œæ‰€ä»¥æŠŠ Object ç±»çœ‹ä½œä¸€ä¸ªçˆ¶ç±»ï¼‰ï¼Œç„¶åç”¨çˆ¶ç±»å‹çš„å˜é‡å»æ¥å—è¿™ä¸ªå®ä¾‹åŒ–çš„å­ç±»ï¼Œæœ€åå»åšäº†ä¸€ä¸ªå¼ºè½¬ã€‚

## åå°„ä¸­å®ä¾‹åŒ–ç±»çš„å‡ ç§æ–¹æ³•

æœ€ç†æƒ³çš„æƒ…å†µä¸‹å°±æ˜¯è¦å®ä¾‹åŒ–çš„ç±»æœ‰ä¸€ä¸ª public çš„æ— å‚æ„é€ æ–¹æ³•ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥é€šè¿‡ newInstance æ–¹æ³•å»å®ä¾‹åŒ–å®ƒï¼Œç„¶åå°±å¼•å‘å‡ºäº†ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯è¯¥ç±»æ²¡æœ‰æ— å‚æ„é€ æ–¹æ³•ã€ä¸€ç§æ˜¯è¯¥ç±»çš„æ„é€ æ–¹æ³•æ˜¯ private çš„ã€‚

1.å…ˆæ¥çœ‹ç¬¬ä¸€ç§æƒ…å†µ-->è¯¥ç±»æ²¡æœ‰æ— å‚æ„é€ å‡½æ•°ï¼Œè¿™ç§æƒ…å†µåœ¨å­¦ä¹  newInstance æ–¹æ³•çš„æ—¶å€™å¯èƒ½å°±é‡åˆ°äº†ï¼Œç½‘ä¸Šæœè¯¥æ–¹æ³•çš„æ—¶å€™ä¼šé‡åˆ°è¿™æ ·çš„ä¸€å¥è¯-->

```
newInstance() å·²è¢«å¼ƒç”¨ï¼šä» Java 9 å¼€å§‹ï¼ŒnewInstance() æ–¹æ³•å·²ç»è¢«æ ‡è®°ä¸ºå¼ƒç”¨ã€‚æ¨èä½¿ç”¨ Constructor.newInstance() æ–¹æ³•æ¥åˆ›å»ºå¯¹è±¡ï¼Œç‰¹åˆ«æ˜¯å½“æ„é€ å‡½æ•°å¸¦æœ‰å‚æ•°æ—¶ã€‚
```

ä¸Šé¢æåŠåˆ°çš„ Constructor å°±æ˜¯è¦æ¥è·å–ç±»çš„æ„é€ å™¨ï¼Œå…¶ä¸­å…³é”®æ˜¯è¦ç”¨åˆ°è¿™ä¸ªæ–¹æ³•-->`getConstructor()`ï¼Œå¾ˆç®€å•ç„¶åå°±å»è·Ÿä¸€ä¸‹è¿™ä¸ª ProcessBuilder è¿™ä¸ªç±»ï¼Œå¹³æ—¶ä¹Ÿä¼šå»ç”¨é‡Œé¢çš„ start()æ–¹æ³•å»æ‰§è¡Œå‘½ä»¤ã€‚ä¸ºå•¥è¦é€‰è¿™ä¸ªç±»ï¼Œå› ä¸ºå®ƒçš„æ„é€ æ–¹æ³•éƒ½æ˜¯å¸¦å‚æ•°çš„ï¼Œè¯¦æƒ…è§ä¸‹å›¾-->

![](6.png)

and

![](7.png)

ç¬¬ä¸€ä¸ªæ„é€ å™¨çš„å‚æ•°æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œç¬¬äºŒä¸ªæ„é€ å™¨çš„å‚æ•°æ˜¯ä¸€ä¸ªå¯å˜é•¿å‚æ•°ï¼ˆä¹Ÿå°±æ˜¯å­—ç¬¦ä¸²æ•°ç»„ï¼‰ï¼Œé’ˆå¯¹ç¬¬ä¸€ä¸ªæ„é€ å™¨æ¥å†™ä¸€ä¸ªå‘½ä»¤æ‰§è¡Œçš„æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹-->

```java
import java.util.Arrays;
import java.util.List;

public class EXP {

    public static void main(String[] args) {
        try{
            Class<?> clazz = Class.forName("java.lang.ProcessBuilder");
            clazz.getMethod("start").invoke(clazz.getConstructor(List.class).newInstance(Arrays.asList("ping","6h50h.cxsys.spacestabs.top")));
        }catch (Exception e){
            e.printStackTrace();
        }
    }
}
```

è¿è¡Œåè§¦å‘å‘½ä»¤æ‰§è¡Œï¼Œç»“æœå¦‚ä¸‹

![](8.png)

ç›¸å½“äºç»™ newInstance è¿™ä¸ªæ–¹æ³•å¢æ·»äº†ä¸€åŒç¿…è†€ï¼Œè®©å®ƒæœ‰èƒ½åŠ›é€šè¿‡ Class å¯¹è±¡å»å®ä¾‹åŒ–ä¸€ä¸ªæ„é€ å‡½æ•°å¸¦å‚æ•°çš„ç±»ã€‚

é‚£ä¹ˆå†æ¥çœ‹ä¸€ä¸‹å¯å˜é•¿å‚æ•°å¦‚ä½•å»æ‰§è¡Œå¦‚ä¸Šçš„ RCEï¼Œä»£ç å¦‚ä¸‹-->

```java
public class EXP {

    public static void main(String[] args) {
        try{
            Class<?> clazz = Class.forName("java.lang.ProcessBuilder");
            clazz.getMethod("start").invoke(clazz.getConstructor(String[].class).newInstance(new String[][]{{"ping","08xak.cxsys.spacestabs.top"}}));
        }catch (Exception e){
            e.printStackTrace();
        }
    }
}
```

è¿è¡Œåè§¦å‘å‘½ä»¤æ‰§è¡Œï¼Œç»“æœå¦‚ä¸‹-->

![](9.png)

æ˜¯äºŒç»´æ•°ç»„çš„åŸå› ï¼šå»è·Ÿä¸€ä¸‹ newInstance è¿™ä¸ªæ–¹æ³•ï¼Œå®ƒçš„å‚æ•°ä¹Ÿæ˜¯ä¸€ä¸ªå˜é•¿å‚æ•°ï¼Œé’ˆå¯¹äºæ•°ç»„è¿™ç§ç±»å‹ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªé»˜è®¤è§£åŒ…çš„è¿‡ç¨‹ã€‚
å°†ä¸Šè¿°å…³é”®ä»£ç æ”¹æˆ`newInstance(new String[]{"ping","08xak.cxsys.spacestabs.top"})`çš„è¯ï¼Œé¦–å…ˆä¼šæŠ¥ä¸€ä¸ªè¿™æ ·çš„é”™è¯¯-->å‚æ•°æ•°é‡ä¸é¢„æœŸçš„æ•°é‡ä¸ä¸€è‡´

![](10.png)

æ˜¾ç„¶åˆ°è¿™é‡Œå°±å·²ç»è§£åŒ…äº†ï¼Œé‚£å¦‚æœæ”¹æˆ`newInstance(new String[]{"ping"})`è¿™ä¸ªæ ·å­ï¼Œè™½ç„¶å¯ä»¥è¿‡äº†è¿™ä¸ªæ•°é‡çš„æ£€æµ‹ï¼Œä½†æ˜¾ç„¶ç±»å‹è¿˜æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¸€ä¸ªæ˜¯ string ç±»å‹ï¼Œè€Œä¸€ä¸ªæ˜¯ string[]ç±»å‹ï¼Œäºæ˜¯ä¹å°±ä¼šå‡ºç°å¦‚ä¸‹çš„æŠ¥é”™-->

![](11.png)

æ›´åŠ ç®€å•ä¸€ç‚¹çš„è§£é‡Šï¼šProcessBuilder éœ€è¦çš„å‚æ•°æ˜¯â¼€ä¸ª String...ç±»å‹çš„ï¼Œä¹Ÿå°±æ˜¯ String[] ç±»å‹çš„ï¼Œç„¶ååâ¾¯çš„ []ï¼Œè¡¨â½° newInstance() æ¥æ”¶çš„å‚æ•°æ˜¯â¼€ä¸ªå˜â»“æ•°ç»„

2.å†æ¥çœ‹ç¬¬äºŒç§æƒ…å†µ-->è¯¥ç±»çš„æ„é€ æ–¹æ³•æ˜¯ private çš„è¯¥å¦‚ä½•åŠï¼Ÿè¿™é‡Œå°±ç”¨åˆ°äº†å¦å¤–ä¸€ä¸ªåè¯`getDeclared`ï¼Œè¿™ä¸ªç³»åˆ—çš„åå°„æ–¹æ³•å’Œ`getMethod` ã€ `getConstructor`è¿™ç§åŒºåˆ«å¦‚ä¸‹ï¼Œå¯¹æ¯”ç€çœ‹å§ã€‚

è¿™æ˜¯ä¸€ç»„ï¼š

- getConstructor() æ–¹æ³•ç”¨äºè·å–ç±»çš„ å…¬å…± æ„é€ æ–¹æ³•ï¼ˆåŒ…æ‹¬ä»çˆ¶ç±»ç»§æ‰¿çš„æ„é€ æ–¹æ³•ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…çš„æ„é€ æ–¹æ³•ï¼Œåˆ™ä¼šæŠ›å‡º NoSuchMethodException å¼‚å¸¸ã€‚

- getDeclaredConstructor() æ–¹æ³•ç”¨äºè·å–ç±»çš„ æ‰€æœ‰æ„é€ æ–¹æ³•ï¼ŒåŒ…æ‹¬ ç§æœ‰çš„ã€ä¿æŠ¤çš„ã€åŒ…ç§æœ‰çš„ä»¥åŠå…¬å…±çš„æ„é€ æ–¹æ³•ã€‚å®ƒä¸ä¼šä»çˆ¶ç±»ç»§æ‰¿ä»»ä½•æ„é€ æ–¹æ³•ï¼Œåªè¿”å›å½“å‰ç±»å£°æ˜çš„æ„é€ æ–¹æ³•ã€‚

è¿™æ˜¯å¦å¤–ä¸€ç»„ï¼š

- getMethods() æ–¹æ³•è¿”å›å½“å‰ç±»åŠå…¶çˆ¶ç±»ï¼ˆåŒ…æ‹¬ Object ç±»ï¼‰å£°æ˜çš„ æ‰€æœ‰å…¬å…±æ–¹æ³•ï¼ŒåŒ…æ‹¬ä»çˆ¶ç±»ç»§æ‰¿çš„å…¬å…±æ–¹æ³•ã€‚

- getDeclaredMethods() æ–¹æ³•è¿”å›å½“å‰ç±»ä¸­å£°æ˜çš„ æ‰€æœ‰æ–¹æ³•ï¼ŒåŒ…æ‹¬ ç§æœ‰æ–¹æ³•ã€ä¿æŠ¤æ–¹æ³•ã€åŒ…ç§æœ‰æ–¹æ³•å’Œå…¬å…±æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œå®ƒ ä¸åŒ…æ‹¬çˆ¶ç±»çš„ä»»ä½•æ–¹æ³•ã€‚

ç„¶åæ¥å®æ“ä¸€ä¸ª RCE çš„ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹-->

```java
import java.lang.reflect.Constructor;

public class Exp {

    public static void main(String[] args) {
        try{
            Class<?> clazz = Class.forName("java.lang.Runtime");
            Constructor m = clazz.getDeclaredConstructor();
            m.setAccessible(true);
            clazz.getMethod("exec",String.class).invoke(m.newInstance(),"ping wrij0.cxsys.spacestabs.top");
        }catch (Exception e){
            e.printStackTrace();
        }
    }
}
```

è¿è¡Œåè§¦å‘å‘½ä»¤æ‰§è¡Œï¼Œç»“æœå¦‚ä¸‹-->

![](12.png)

Tipsï¼šä¸Šé¢è¿™ç§æ–¹å¼è²Œä¼¼åœ¨é«˜ç‰ˆæœ¬æ‰“ä¸é€šï¼Œæ¢æˆ Java 8 å°±å¥½äº†

åå°„ä» 0 åˆ° 1ï¼ŒåŸºæœ¬ç»“æŸ ğŸ”š